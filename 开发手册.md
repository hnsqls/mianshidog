# é¡¹ç›®ä»‹ç»

 é¢è¯•ç‹—ï¼Œå¸®åŠ©æ±‚èŒè€…æ›´åŠ æœ‰æ•ˆçš„å¯»æ‰¾é¢è¯•é¢˜ã€‚

# é¡¹ç›®èƒŒæ™¯

é¢è¯•é¢˜æ•´ç†èµ·æ¥æœç´¢ä¸æ–¹ä¾¿ã€‚

# æ ¸å¿ƒä¸šåŠ¡æµç¨‹

![image-20240827092722792](images/å¼€å‘æ‰‹å†Œ.assets/image-20240827092722792.png)



# é¡¹ç›®åŠŸèƒ½æ¢³ç†

**åŸºç¡€åŠŸèƒ½P0**

* ç”¨æˆ·æ¨¡å—
  * ç”¨æˆ·æ³¨å†Œ
  * ç™»å½•
  * [ç®¡ç†å‘˜]ç®¡ç†ç”¨æˆ·-å¢åˆ æ”¹æŸ¥ã€‚
* é¢˜åº“æ¨¡å—
  * æŸ¥çœ‹é¢˜åº“åˆ—è¡¨
  * æŸ¥çœ‹é¢˜åº“è¯¦æƒ…ï¼ˆé¢˜åº“ä¸‹çš„é¢˜ç›®ï¼‰
  * [ç®¡ç†å‘˜]ç®¡ç†é¢˜åº“-å¢åˆ æ”¹æŸ¥ã€‚
* é¢˜ç›®æ¨¡å—
  * é¢˜ç›®æœç´¢
  * æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…
  * ã€ç®¡ç†å‘˜ã€‘ç®¡ç†é¢˜ç›®

**é«˜çº§åŠŸèƒ½P1~P2**

* é¢˜ç›®æ‰¹é‡ç®¡ç† P1
  * ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡å‘é¢˜ç›®æ·»åŠ é¢˜ç›®
  * ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®
  * ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡åˆ é™¤é¢˜ç›®
* åˆ†è¯é¢˜ç›®æœç´¢ P1
* ç”¨æˆ·åˆ·é¢˜è®°å½•æ—¥å†å›¾P1
* è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜ç›®P2
* é€šæ–­ç™»å½•å†²çªæ£€æµ‹P2







# ç¯å¢ƒå‡†å¤‡

jdk17

mysql 8

# åº“è¡¨è®¾è®¡

```sql
-- åˆ›å»ºåº“
create database if not exists mianshidog;

-- åˆ‡æ¢åº“
use mianshidog;

-- ç”¨æˆ·è¡¨
create table if not exists user
(
    id           bigint auto_increment comment 'id' primary key,
    userAccount  varchar(256)                           not null comment 'è´¦å·',
    userPassword varchar(512)                           not null comment 'å¯†ç ',
    unionId      varchar(256)                           null comment 'å¾®ä¿¡å¼€æ”¾å¹³å°id',
    mpOpenId     varchar(256)                           null comment 'å…¬ä¼—å·openId',
    userName     varchar(256)                           null comment 'ç”¨æˆ·æ˜µç§°',
    userAvatar   varchar(1024)                          null comment 'ç”¨æˆ·å¤´åƒ',
    userProfile  varchar(512)                           null comment 'ç”¨æˆ·ç®€ä»‹',
    userRole     varchar(256) default 'user'            not null comment 'ç”¨æˆ·è§’è‰²ï¼šuser/admin/ban',
    editTime     datetime     default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',
    createTime   datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete     tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    index idx_unionId (unionId)
) comment 'ç”¨æˆ·' collate = utf8mb4_unicode_ci;

-- é¢˜åº“è¡¨
create table if not exists question_bank
(
    id          bigint auto_increment comment 'id' primary key,
    title       varchar(256)                       null comment 'æ ‡é¢˜',
    description text                               null comment 'æè¿°',
    picture     varchar(2048)                      null comment 'å›¾ç‰‡',
    userId      bigint                             not null comment 'åˆ›å»ºç”¨æˆ· id',
    editTime    datetime default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',
    createTime  datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime  datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete    tinyint  default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    index idx_title (title)
) comment 'é¢˜åº“' collate = utf8mb4_unicode_ci;

-- é¢˜ç›®è¡¨
create table if not exists question
(
    id         bigint auto_increment comment 'id' primary key,
    title      varchar(256)                       null comment 'æ ‡é¢˜',
    content    text                               null comment 'å†…å®¹',
    tags       varchar(1024)                      null comment 'æ ‡ç­¾åˆ—è¡¨ï¼ˆjson æ•°ç»„ï¼‰',
    answer     text                               null comment 'æ¨èç­”æ¡ˆ',
    userId     bigint                             not null comment 'åˆ›å»ºç”¨æˆ· id',
    editTime   datetime default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',
    createTime datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete   tinyint  default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    index idx_title (title),
    index idx_userId (userId)
) comment 'é¢˜ç›®' collate = utf8mb4_unicode_ci;

-- é¢˜åº“é¢˜ç›®è¡¨ï¼ˆç¡¬åˆ é™¤ï¼‰
create table if not exists question_bank_question
(
    id             bigint auto_increment comment 'id' primary key,
    questionBankId bigint                             not null comment 'é¢˜åº“ id',
    questionId     bigint                             not null comment 'é¢˜ç›® id',
    userId         bigint                             not null comment 'åˆ›å»ºç”¨æˆ· id',
    createTime     datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime     datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    UNIQUE (questionBankId, questionId)
) comment 'é¢˜åº“é¢˜ç›®' collate = utf8mb4_unicode_ci;
```



# å‡†å¤‡å·¥ä½œ

mybaits-xç”Ÿæˆç›¸å…³ä»£ç ã€‚

ä½¿ç”¨æˆ‘ä»¬å†™å¥½çš„ä»£ç ç”Ÿæˆå™¨ï¼Œç”Ÿæˆcrudä»£ç 

æ•°æ®æ¨¡å‹å¼€å‘dtoå’Œvo

# debug



## æ•°æ®å‡†å¤‡

```sql
-- åˆå§‹æ•°æ®
use mianshidog;

-- ç”¨æˆ·è¡¨åˆå§‹æ•°æ®ï¼ˆå¯†ç æ˜¯ 12345678ï¼‰
INSERT INTO user (id, userAccount, userPassword, unionId, mpOpenId, userName, userAvatar, userProfile, userRole)
VALUES (1, 'user1', 'b0dd3697a192885d7c055db46155b26a', 'unionId1', 'mpOpenId1', 'user1',
        'https://www.code-nav.cn/logo.png', 'å–œæ¬¢ç¼–ç¨‹çš„å°ç™½', 'user'),
       (2, 'user2', 'b0dd3697a192885d7c055db46155b26a', 'unionId2', 'mpOpenId2', 'user2',
        'https://www.code-nav.cn/logo.png', 'å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ', 'user'),
       (3, 'user3', 'b0dd3697a192885d7c055db46155b26a', 'unionId3', 'mpOpenId3', 'user3',
        'https://www.code-nav.cn/logo.png', 'å‰ç«¯çˆ±å¥½è€…', 'user'),
       (4, 'user4', 'b0dd3697a192885d7c055db46155b26a', 'unionId4', 'mpOpenId4', 'user4',
        'https://www.code-nav.cn/logo.png', 'åç«¯å¼€å‘å·¥ç¨‹å¸ˆ', 'user'),
       (5, 'æç¡•', 'b0dd3697a192885d7c055db46155b26a', NULL, NULL, 'hnsqls', 'https://www.code-nav.cn/logo.png',
        'ç³»ç»Ÿç®¡ç†å‘˜', 'admin');

-- é¢˜åº“è¡¨åˆå§‹æ•°æ®
INSERT INTO question_bank (title, description, picture, userId)
VALUES ('JavaScript åŸºç¡€', 'åŒ…å« JavaScript çš„åŸºç¡€çŸ¥è¯†é¢˜ç›®',
        'https://pic.code-nav.cn/mianshiya/question_bank_picture/1777886594896760834/JldkWf9w_JavaScript.png', 1),
       ('CSS æ ·å¼', 'åŒ…å« CSS ç›¸å…³çš„æ ·å¼é—®é¢˜',
        'https://pic.code-nav.cn/mianshiya/question_bank_picture/1777886594896760834/QatnFmEN_CSS.png', 2),
       ('HTML åŸºç¡€', 'HTML æ ‡è®°è¯­è¨€çš„åŸºæœ¬çŸ¥è¯†', 'https://www.mianshiya.com/logo.png', 3),
       ('å‰ç«¯æ¡†æ¶', 'React, Vue, Angular ç­‰æ¡†æ¶ç›¸å…³çš„é¢˜ç›®', 'https://www.mianshiya.com/logo.png', 1),
       ('ç®—æ³•ä¸æ•°æ®ç»“æ„', 'æ•°æ®ç»“æ„å’Œç®—æ³•é¢˜ç›®', 'https://www.mianshiya.com/logo.png', 2),
       ('æ•°æ®åº“åŸç†', 'SQL è¯­å¥å’Œæ•°æ®åº“è®¾è®¡', 'https://www.mianshiya.com/logo.png', 3),
       ('æ“ä½œç³»ç»Ÿ', 'æ“ä½œç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µ', 'https://www.mianshiya.com/logo.png', 1),
       ('ç½‘ç»œåè®®', 'HTTP, TCP/IP ç­‰ç½‘ç»œåè®®é¢˜ç›®', 'https://www.mianshiya.com/logo.png', 2),
       ('è®¾è®¡æ¨¡å¼', 'å¸¸è§è®¾è®¡æ¨¡å¼åŠå…¶åº”ç”¨', 'https://www.mianshiya.com/logo.png', 3),
       ('ç¼–ç¨‹è¯­è¨€æ¦‚è¿°', 'å¤šç§ç¼–ç¨‹è¯­è¨€çš„åŸºç¡€çŸ¥è¯†', 'https://www.mianshiya.com/logo.png', 1),
       ('ç‰ˆæœ¬æ§åˆ¶', 'Git å’Œ SVN çš„ä½¿ç”¨', 'https://www.mianshiya.com/logo.png', 2),
       ('å®‰å…¨ä¸åŠ å¯†', 'ç½‘ç»œå®‰å…¨å’ŒåŠ å¯†æŠ€æœ¯', 'https://www.mianshiya.com/logo.png', 3),
       ('äº‘è®¡ç®—', 'äº‘æœåŠ¡å’Œæ¶æ„', 'https://www.mianshiya.com/logo.png', 1),
       ('å¾®æœåŠ¡æ¶æ„', 'å¾®æœåŠ¡çš„è®¾è®¡ä¸å®ç°', 'https://www.mianshiya.com/logo.png', 2),
       ('å®¹å™¨æŠ€æœ¯', 'Docker å’Œ Kubernetes ç›¸å…³çŸ¥è¯†', 'https://www.mianshiya.com/logo.png', 3),
       ('DevOps å®è·µ', 'æŒç»­é›†æˆä¸æŒç»­äº¤ä»˜', 'https://www.mianshiya.com/logo.png', 1),
       ('æ•°æ®åˆ†æ', 'æ•°æ®åˆ†æå’Œå¯è§†åŒ–', 'https://www.mianshiya.com/logo.png', 2),
       ('äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ ä¸æ·±åº¦å­¦ä¹ åŸºç¡€', 'https://www.mianshiya.com/logo.png', 3),
       ('åŒºå—é“¾æŠ€æœ¯', 'åŒºå—é“¾çš„åŸºæœ¬åŸç†å’Œåº”ç”¨', 'https://www.mianshiya.com/logo.png', 1),
       ('é¡¹ç›®ç®¡ç†', 'è½¯ä»¶å¼€å‘é¡¹ç›®çš„ç®¡ç†å’Œæ‰§è¡Œ', 'https://www.mianshiya.com/logo.png', 2);

-- é¢˜ç›®è¡¨åˆå§‹æ•°æ®
INSERT INTO question (title, content, tags, answer, userId)
VALUES ('JavaScript å˜é‡æå‡', 'è¯·è§£é‡Š JavaScript ä¸­çš„å˜é‡æå‡ç°è±¡ã€‚', '["JavaScript", "åŸºç¡€"]',
        'å˜é‡æå‡æ˜¯æŒ‡åœ¨ JavaScript ä¸­ï¼Œå˜é‡å£°æ˜ä¼šè¢«æå‡åˆ°ä½œç”¨åŸŸçš„é¡¶éƒ¨ã€‚', 1),
       ('CSS Flexbox å¸ƒå±€', 'å¦‚ä½•ä½¿ç”¨ CSS å®ç°ä¸€ä¸ªæ°´å¹³å±…ä¸­çš„ç›’å­ï¼Ÿ', '["CSS", "å¸ƒå±€"]',
        'å¯ä»¥ä½¿ç”¨ Flexbox å¸ƒå±€ï¼Œé€šè¿‡è®¾ç½®çˆ¶å®¹å™¨ display ä¸º flexï¼Œå¹¶ä½¿ç”¨ justify-content: center; å¯¹é½å­å…ƒç´ ã€‚', 2),
       ('HTML ä¸­çš„è¯­ä¹‰åŒ–', 'ä»€ä¹ˆæ˜¯ HTML çš„è¯­ä¹‰åŒ–ï¼Ÿä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ', '["HTML", "è¯­ä¹‰åŒ–"]',
        'HTML è¯­ä¹‰åŒ–æ˜¯ä½¿ç”¨æ­£ç¡®çš„æ ‡ç­¾æ¥æè¿°å†…å®¹çš„æ„ä¹‰ï¼Œèƒ½å¤Ÿæé«˜å¯è®¿é—®æ€§å’Œ SEO æ•ˆæœã€‚', 3),
       ('React ä¸­çš„çŠ¶æ€ç®¡ç†', 'å¦‚ä½•åœ¨ React ä¸­ç®¡ç†ç»„ä»¶çŠ¶æ€ï¼Ÿ', '["React", "çŠ¶æ€ç®¡ç†"]',
        'å¯ä»¥ä½¿ç”¨ React çš„ useState æˆ– useReducer é’©å­æ¥ç®¡ç†ç»„ä»¶çŠ¶æ€ï¼Œæˆ–ä½¿ç”¨ Redux è¿›è¡Œå…¨å±€çŠ¶æ€ç®¡ç†ã€‚', 1),
       ('ç®—æ³•ï¼šäºŒåˆ†æŸ¥æ‰¾', 'è¯·å®ç°ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ã€‚', '["ç®—æ³•", "æ•°æ®ç»“æ„"]',
        'äºŒåˆ†æŸ¥æ‰¾æ˜¯ä¸€ç§åœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾ç‰¹å®šå…ƒç´ çš„ç®—æ³•ï¼Œé€šè¿‡ä¸æ–­æŠ˜åŠçš„æ–¹å¼ç¼©å°æŸ¥æ‰¾èŒƒå›´ã€‚', 2),
       ('æ•°æ®åº“ç´¢å¼•çš„ä½œç”¨', 'ä»€ä¹ˆæ˜¯æ•°æ®åº“ç´¢å¼•ï¼Ÿå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ', '["æ•°æ®åº“", "ç´¢å¼•"]',
        'æ•°æ®åº“ç´¢å¼•æ˜¯ç”¨äºåŠ å¿«æŸ¥è¯¢é€Ÿåº¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒé€šè¿‡ä¼˜åŒ–æŸ¥æ‰¾è·¯å¾„å‡å°‘æŸ¥è¯¢æ—¶é—´ã€‚', 3),
       ('HTTP ä¸ HTTPS çš„åŒºåˆ«', 'è¯·è§£é‡Š HTTP å’Œ HTTPS ä¹‹é—´çš„ä¸»è¦åŒºåˆ«ã€‚', '["ç½‘ç»œ", "åè®®"]',
        'HTTPS æ˜¯åŠ å¯†çš„ HTTPï¼Œé€šè¿‡ SSL/TLS æä¾›æ›´å®‰å…¨çš„æ•°æ®ä¼ è¾“ã€‚', 1),
       ('è®¾è®¡æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼', 'è¯·è§£é‡Šå•ä¾‹æ¨¡å¼çš„å®ç°åŠåº”ç”¨åœºæ™¯ã€‚', '["è®¾è®¡æ¨¡å¼", "å•ä¾‹"]',
        'å•ä¾‹æ¨¡å¼ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹ã€‚å¸¸ç”¨äºé…ç½®ç±»ç­‰åªéœ€ä¸€ä¸ªå®ä¾‹çš„åœºæ™¯ã€‚', 2),
       ('Git ä¸­çš„åˆ†æ”¯ç®¡ç†', 'å¦‚ä½•åœ¨ Git ä¸­ç®¡ç†åˆ†æ”¯ï¼Ÿ', '["ç‰ˆæœ¬æ§åˆ¶", "Git"]',
        'Git ä¸­é€šè¿‡ branch å‘½ä»¤åˆ›å»ºåˆ†æ”¯ï¼Œä½¿ç”¨ checkout åˆ‡æ¢åˆ†æ”¯ï¼Œä½¿ç”¨ merge åˆå¹¶åˆ†æ”¯ã€‚', 3),
       ('Docker çš„åŸºæœ¬å‘½ä»¤', 'åˆ—ä¸¾å¹¶è§£é‡Šå‡ ä¸ªå¸¸ç”¨çš„ Docker å‘½ä»¤ã€‚', '["å®¹å™¨æŠ€æœ¯", "Docker"]',
        'å¸¸ç”¨å‘½ä»¤åŒ…æ‹¬ docker run, docker build, docker ps, docker stop ç­‰ã€‚', 1),
       ('å‰ç«¯æ€§èƒ½ä¼˜åŒ–', 'åˆ—ä¸¾å‡ ä¸ªå‰ç«¯æ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µã€‚', '["å‰ç«¯", "æ€§èƒ½ä¼˜åŒ–"]',
        'åŒ…æ‹¬ä»£ç åˆ†å‰²ã€èµ„æºå‹ç¼©ã€ç¼“å­˜ç­–ç•¥ã€æ‡’åŠ è½½ç­‰ã€‚', 2),
       ('JavaScript é—­åŒ…çš„åº”ç”¨', 'ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿä¸¾ä¾‹è¯´æ˜é—­åŒ…çš„å®é™…åº”ç”¨ã€‚', '["JavaScript", "é«˜çº§"]',
        'é—­åŒ…æ˜¯æŒ‡å‡½æ•°èƒ½å¤Ÿè®°ä½åˆ›å»ºæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¸¸ç”¨äºæ•°æ®éšè—å’Œæ¨¡å—åŒ–ç¼–ç¨‹ã€‚', 3),
       ('æ•°æ®åº“äº‹åŠ¡çš„ç‰¹æ€§', 'è¯·è§£é‡Šæ•°æ®åº“äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚', '["æ•°æ®åº“", "äº‹åŠ¡"]',
        'ACID ä»£è¡¨åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ï¼Œæ˜¯äº‹åŠ¡å¤„ç†çš„å››å¤§ç‰¹æ€§ã€‚', 1),
       ('CSS çš„ BEM å‘½åè§„èŒƒ', 'ä»€ä¹ˆæ˜¯ BEMï¼Ÿå¦‚ä½•ä½¿ç”¨ BEM è¿›è¡Œ CSS å‘½åï¼Ÿ', '["CSS", "å‘½åè§„èŒƒ"]',
        'BEM ä»£è¡¨å—ï¼ˆBlockï¼‰ã€å…ƒç´ ï¼ˆElementï¼‰å’Œä¿®é¥°ç¬¦ï¼ˆModifierï¼‰ï¼Œæ˜¯ä¸€ç§ CSS å‘½åè§„èŒƒã€‚', 2),
       ('JavaScript åŸå‹é“¾', 'è¯·è§£é‡Š JavaScript ä¸­çš„åŸå‹é“¾æœºåˆ¶ã€‚', '["JavaScript", "åŸå‹é“¾"]',
        'åŸå‹é“¾æ˜¯ JavaScript å®ç°ç»§æ‰¿çš„æœºåˆ¶ï¼Œå¯¹è±¡é€šè¿‡åŸå‹é“¾å¯ä»¥ç»§æ‰¿å…¶ä»–å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚', 3),
       ('React ç”Ÿå‘½å‘¨æœŸ', 'è¯·è¯´æ˜ React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚', '["React", "ç”Ÿå‘½å‘¨æœŸ"]',
        'React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬åˆå§‹åŒ–ã€æ›´æ–°å’Œå¸è½½ä¸‰ä¸ªé˜¶æ®µï¼Œå„é˜¶æ®µæœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚', 1),
       ('HTTP çŠ¶æ€ç  404 ä¸ 500 çš„åŒºåˆ«', 'è¯·è§£é‡Š HTTP çŠ¶æ€ç  404 å’Œ 500 çš„å«ä¹‰ã€‚', '["ç½‘ç»œ", "HTTP"]',
        '404 è¡¨ç¤ºæœªæ‰¾åˆ°èµ„æºï¼Œ500 è¡¨ç¤ºæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ã€‚', 2),
       ('Python ä¸ Java çš„åŒºåˆ«', 'æ¯”è¾ƒ Python å’Œ Java çš„ä¸»è¦åŒºåˆ«ã€‚', '["ç¼–ç¨‹è¯­è¨€", "Python", "Java"]',
        'Python æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œè¯­æ³•ç®€æ´ï¼Œè€Œ Java æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œæ³¨é‡ä¸¥è°¨æ€§å’Œæ€§èƒ½ã€‚', 3),
       ('Vue çš„åŒå‘æ•°æ®ç»‘å®š', 'è¯·è§£é‡Š Vue.js æ˜¯å¦‚ä½•å®ç°åŒå‘æ•°æ®ç»‘å®šçš„ã€‚', '["Vue", "æ•°æ®ç»‘å®š"]',
        'Vue.js é€šè¿‡æ•°æ®åŠ«æŒå’Œå‘å¸ƒ-è®¢é˜…æ¨¡å¼å®ç°äº†åŒå‘æ•°æ®ç»‘å®šã€‚', 1),
       ('å‰ç«¯å·¥ç¨‹åŒ–çš„æ„ä¹‰', 'ä¸ºä»€ä¹ˆéœ€è¦å‰ç«¯å·¥ç¨‹åŒ–ï¼Ÿ', '["å‰ç«¯", "å·¥ç¨‹åŒ–"]',
        'å‰ç«¯å·¥ç¨‹åŒ–èƒ½å¤Ÿæé«˜å¼€å‘æ•ˆç‡ã€ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ï¼Œè§„èŒƒå¼€å‘æµç¨‹ã€‚', 2);

-- é¢˜åº“é¢˜ç›®å…³è”åˆå§‹æ•°æ®
INSERT INTO question_bank_question (questionBankId, questionId, userId)
VALUES (1, 1, 1),
       (1, 2, 1),
       (1, 3, 1),
       (1, 4, 1),
       (1, 5, 1),
       (1, 6, 1),
       (1, 7, 1),
       (1, 8, 1),
       (1, 9, 1),
       (1, 10, 1),
       (2, 2, 2),
       (2, 14, 2),
       (3, 3, 3),
       (3, 13, 3),
       (4, 4, 1),
       (4, 16, 1),
       (5, 5, 2),
       (5, 18, 2),
       (6, 6, 3),
       (6, 19, 3),
       (7, 7, 1),
       (7, 11, 1),
       (8, 8, 2),
       (8, 10, 2),
       (9, 9, 3),
       (9, 17, 3),
       (10, 12, 1),
       (10, 20, 1);

```

# æ‰©å±•åŠŸèƒ½

## 1.ç”¨æˆ·ç­¾åˆ°è®°å½•

### 1.1 éœ€æ±‚åˆ†æ

ä¸ºäº†é¼“åŠ±ç”¨æˆ·å¤šåˆ·é¢˜ï¼Œå¼€å‘ç­¾åˆ°è®°å½•ï¼Œå¹¶ä»¥æ—¥å†å›¾çš„æ–¹å¼æ˜¾ç¤ºã€‚

### 1.2 æ–¹æ¡ˆè®¾è®¡

**1.2.1 æ–¹æ¡ˆä¸€ æ•°æ®åº“**

æ•°æ®åº“å­˜ç­¾åˆ°ä¿¡æ¯ï¼Œé€šè¿‡å”¯ä¸€ç´¢å¼•ç¡®ä¿ä¸€å¤©ç­¾åˆ°ä¸€æ¬¡

```sql
CREATE TABLE user_sign_in (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- ä¸»é”®ï¼Œè‡ªåŠ¨é€’å¢
  userId BIGINT NOT NULL,               -- ç”¨æˆ·IDï¼Œå…³è”ç”¨æˆ·è¡¨
  signDate DATE NOT NULL,            -- ç­¾åˆ°æ—¥æœŸ
  createdTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- è®°å½•åˆ›å»ºæ—¶é—´
  UNIQUE KEY uq_user_date (userId, signDate)  -- ç”¨æˆ·IDå’Œç­¾åˆ°æ—¥æœŸçš„å”¯ä¸€æ€§çº¦æŸ
);

```

æŸ¥è¯¢ç”¨æˆ·çš„ç­¾åˆ°ä¿¡æ¯

```sql
SELECT signDate FROM user_sign_in 
WHERE userId = ? AND signDate BETWEEN ï¼ŸAND ?;
```

ä¼˜ç‚¹ï¼šåŸç†ç®€å•ï¼Œå®ç°å®¹æ˜“

ç¼ºç‚¹ï¼šéšç€ç”¨æˆ·çš„æ•°é‡å¢å¤§ï¼Œå¯¹æ•°æ®åº“çš„å‹åŠ›è¾ƒå¤§

**1.2.2 æ–¹æ¡ˆäºŒ-Redis Set**

redis key : `user:signins:{userid}`

redis value : `2024-09-28`

å¦‚ä¸‹å‘½ä»¤æ–°å¢é›†åˆ

```shell
SADD user:signins:123 "2024-09-01"
SADD user:signins:123 "2024-09-02"
```

æŸ¥æ‰¾è®°å½•

```shell
SMEMBERS user:signins:123
```

ä¼˜ç‚¹ï¼šsetç»“æ„å¤©ç„¶å»é‡ï¼ŒredisåŸºäºå†…å­˜é€Ÿåº¦å—ã€‚

ç¼ºç‚¹ï¼šä¸Šè¿°è®¾è®¡å­˜å‚¨äº†å¤§é‡çš„é‡å¤çš„å­—ç¬¦ä¸²å¦‚å¹´ä»½ï¼Œå¤ªæµªè´¹å†…å­˜äº†

å¦‚ä¸‹å­˜çš„æ•°æ®ï¼Œå¯ä»¥å°†å¹´ä»½æå–ä½œä¸ºkeyçš„éƒ¨åˆ†ï¼Œè¿™æ ·å­˜å‚¨çš„æ•°æ®å°±å‡å°‘äº†å¾ˆå¤š

```shell
key = user:signins:123
value = ["2024-09-01", "2024-09-02", "2024-10-01", "2024-10-02"]
```

**1.2.3æ–¹æ¡ˆä¸‰-Bitmapä½å›¾**

bitmapä½å›¾æ˜¯ä¸€ç§ä½¿ç”¨ï¼ˆbitï¼‰ä½æ¥è¡¨ç¤ºæ•°æ®çš„ç´§å‡‘æ•°æ®ç»“æ„ï¼Œæ¯ä¸€ä½èƒ½å­˜0æˆ–1ï¼Œç”¨æ¥è¡¨ç¤ºæŸç§çŠ¶æ€æˆ–æ ‡è¯†ï¼Œå› ä¸ºæ¯ä¸ºåªå ç”¨ä¸€bitä½ï¼ŒBitmapåœ¨å­˜å‚¨å¤§è§„æ¨¡äºŒå€¼æ•°æ®ï¼ˆå¦‚å¸ƒå°”ï¼‰éå¸¸é«˜æ•ˆä¸”èŠ‚çº¦ç©ºé—´ã€‚



ç”¨Bitmapæ¥åšç­¾åˆ°çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå­˜å‚¨ç”¨æˆ·åœ¨ä»Šå¹´çš„ç¬¬å‡ å¤©ç­¾åˆ°ï¼Œè€Œä¸æ˜¯å­˜ä¸€ä¸ªå®Œæ•´çš„æ—¥æœŸã€‚

```java
2024-01-01 => 1ï¼ˆç¬¬ä¸€å¤©ï¼‰
2024-01-03 => 3ï¼ˆç¬¬ä¸‰å¤©ï¼‰
```

ä½¿ç”¨Bitmapç±»å‹å­˜æ•°æ®ï¼Œæ¯ä¸ªç”¨æˆ·å¯¹åº”ä¸€ä¸ªkeyï¼ŒBiyMapçš„æ¯ä¸€ä½æ¥è¡¨ç¤ºæŸä¸€å¤©æ˜¯å¦æ‰“å¡ã€‚

å¦‚ä¸‹ä¾‹ï¼š 0è¡¨ç¤ºæœªç­¾åˆ°ï¼Œ1è¡¨ç¤ºç­¾åˆ°

```java
0101 è¡¨ç¤ºç¬¬ 1 å¤©å’Œç¬¬ 3 å¤©å·²ç­¾åˆ°
1010 è¡¨ç¤ºç¬¬ 2 å¤©å’Œç¬¬ 4 å¤©å·²ç­¾åˆ°
```

é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨bitmapå‘¢ï¼Ÿ

JDKè‡ªå¸¦äº†BitSetç±»ï¼ŒRedisä¹Ÿæ”¯æŒbitmapæ•°æ®ç»“æ„ã€‚

RedisKeyçš„è®¾è®¡ï¼š`user:signins:{å¹´ä»½}ï¼š{userid}`

RedisValueçš„è®¾è®¡ï¼š`01010010100` bitmapç±»å‹çš„æ•°æ®ã€‚

ç”¨redisæ”¯æŒçš„bitmapæ“ä½œå¦‚ä¸‹

æ–°å¢

```shell
-- è¡¨ç¤ºç”¨æˆ·åœ¨ç¬¬ 240 å¤©æ‰“å¡
SETBIT user:signins:2024:123 240 1
-- è¡¨ç¤ºç”¨æˆ·åœ¨ç¬¬ 241 å¤©æ‰“å¡
SETBIT user:signins:2024:123 241 1

```

æŸ¥è¯¢

```shell
GETBIT user:signins:2024:123 240
```

åœ¨Javaç¨‹åºä¸­æä¾›äº†javaå®¢æˆ·å¸¦`Redission`

### 1.3 å¼€å‘æ¥å£

æ˜ç¡®å¼€å‘æ¥å£ï¼š åœ¨ç”¨æˆ·æ¯æ—¥é¦–æ¬¡æŸ¥è¯¢æŸä¸ªé¢˜ç›®è¯¦æƒ…çš„æ—¶å€™ï¼Œç­¾åˆ°ã€‚

#### 1.3.1å¼•å…¥Redission

1.å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.redisson</groupId>
  <artifactId>redisson</artifactId>
  <version>3.21.0</version>
</dependency>
```

2.é…ç½®rediså‚æ•°

```yaml
  # Redis é…ç½®
  # todo éœ€æ›¿æ¢é…ç½®ï¼Œç„¶åå–æ¶ˆæ³¨é‡Š
  redis:
    database: 1
    host: localhost
    port: 6379
    timeout: 5000
    password: 123456
```

3. åˆå§‹åŒ–redissionå®¢æœç«¯.åœ¨configåŒ…ä¸‹åˆ›å»º

```java
/**
 * redissoné…ç½®
 */
@Configuration
@ConfigurationProperties(prefix = "spring.redis")
@Data
public class RedissonConfig {


    private  String host;

    private Integer port;

    private Integer database;

    private String password;

    @Bean
    public RedissonClient redissonClient(){
        Config config = new Config();
        config.useSingleServer()
                .setAddress("redis://" + host +":"+ port)
                .setDatabase(database)
                .setPassword(password);


        return Redisson.create(config);
    }
}
```

å°è¯•å¯åŠ¨é¡¹ç›®çœ‹æ˜¯å¦æŠ¥é”™ã€‚

#### 1.3.2 æ·»åŠ åˆ·é¢˜ç­¾åˆ°æ¥å£

è§¦å‘æ—¶æœºï¼šå·²ç™»å½•ç”¨æˆ·æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…æ—¶ï¼Œè°ƒç”¨æ¥å£ï¼Œç­¾åˆ°ã€‚

ä¸šåŠ¡é€»è¾‘ï¼šå·²ç»ç™»å½•ç”¨æˆ·ï¼ŒæŸ¥çœ‹é¢˜ç›®è¯¦æƒ…ï¼Œåˆ¤æ–­ä»Šå¤©æ˜¯å¦å·²ç»ç­¾åˆ°ï¼Œæœªç­¾åˆ°å°±åœ¨bitmapæ–°å¢ï¼Œå·²ç­¾åˆ°å°±ä¸ç”¨å¤„ç†ã€‚

rediskey è®¾è®¡ï¼š`mainshidog:user:signins:{year}:{userid}` 

å› ä¸ºå¯¹rediè¯»å†™ éœ€è¦å¤šæ¬¡è¯»å†™ç›¸åŒçš„keyï¼Œæ‰€ä»¥å°†redis key çš„å®šä¹‰å•ç‹¬æ”¾åœ¨ä¸€èµ·å®šä¹‰å¸¸é‡.



1.åœ¨constantåŒ…ä¸‹åˆ›å»º

```java
public interface RedisConstant {

    /**
     * ç”¨æˆ·ç­¾åˆ°è®°å½•çš„ Redis Key å‰ç¼€
     */
    String USER_SIGN_IN_REDIS_KEY_PREFIX = "user:signins";

    /**
     * è·å–ç”¨æˆ·ç­¾åˆ°è®°å½•çš„ Redis Key
     * @param year å¹´ä»½
     * @param userId ç”¨æˆ· id
     * @return æ‹¼æ¥å¥½çš„ Redis Key
     */
    static String getUserSignInRedisKey(int year, long userId) {
        return String.format("%s:%s:%s", USER_SIGN_IN_REDIS_KEY_PREFIX, year, userId);
    }
}
```

2. UserServiceæ¥å£

   ```java
   /**
    * æ·»åŠ ç”¨æˆ·ç­¾åˆ°è®°å½•
    *
    * @param userId ç”¨æˆ· id
    * @return å½“å‰æ˜¯å¦å·²ç­¾åˆ°æˆåŠŸ
    */
   boolean addUserSignIn(long userId);
   
   ```

3. ç¼–å†™å®ç°ç±»

```java
    /**
     * æ·»åŠ ç”¨æˆ·ç­¾åˆ°è®°å½•
     *
     * @param userId ç”¨æˆ·ç­¾åˆ°
     * @return å½“å‰æ˜¯å¦å·²ç­¾åˆ°æˆåŠŸ
     */
    public boolean addUserSignIn(long userId) {
        // å½“å‰æ—¥æœŸ
        LocalDate localDate = LocalDate.now();
        int year = localDate.getYear();
        String key = RedisConstant.getUserSignInRedisKey(year, userId);

        //è·å–bitmap æ•°æ®
        RBitSet bitSet = redissonClient.getBitSet(key);
        //ä¸€å¹´çš„åç§»é‡  ä»ä¸€å¼€å§‹
        int dayOfYear = localDate.getDayOfYear();
        //æ˜¯å¦å·²ç»ç­¾åˆ°
        if (!bitSet.get(dayOfYear)){
            //æ²¡æœ‰ç­¾åˆ°
            bitSet.set(dayOfYear,true);
        }
        //å·²ç»ç­¾åˆ°
        return  true;
        
    }
```

4. ç¼–å†™controllerè¯·æ±‚

```java
    /**
     * æ–°å¢ç”¨æˆ·åˆ·é¢˜ç­¾åˆ°è®°å½•
     *
     * @param
     * @param request
     * @return
     */
    @PostMapping("/add/sign_in")
    public BaseResponse<Boolean> addUserSignIn(HttpServletRequest request) {
        //ç™»å½•çš„ç”¨æˆ·
        User loginUser = userService.getLoginUser(request);
        boolean result= userService.addUserSignIn(loginUser.getId());
        return ResultUtils.success(result);
    }
```

æ¥å£æµ‹è¯•

![image-20240929092710218](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929092710218.png)

#### 1.3.3æŸ¥è¯¢æŸ¥è¯¢ç­¾åˆ°æ¥å£

ä¸šåŠ¡é€»è¾‘ï¼š 1.é€šè¿‡useridå’Œå¹´ä»½æŸ¥è¯¢bitmapã€‚2.è·å–å¹´ä»½å¤©æ•°ï¼Œ3.æ‹¼æ¥æ—¥æœŸï¼Œæ ¹æ®æ—¥æœŸå»bitmapä¸­æŸ¥æ˜¯å¦ç­¾åˆ°ï¼Œå¹¶è®°å½•åœ¨æ•°ç»„ä¸­

4.å°†æ‹¼æ¥å¥½çš„ä¸€å¹´å†…çš„è®°å½•è¿”å›å‰ç«¯ã€‚

1. Userserviceæ¥å£

```java
  /**
     * è·å–ç­¾åˆ°è®°å½•
     * @param year
     * @param userid
     * @return  ä¸€æ•´å¹´ç­¾åˆ°è®°å½•çš„é›†åˆ  [[2024-09-28:true],[2024-09-29:false],[2024-09-30:false]]
     */
    Map<LocalDate,Boolean> getUserSignIn(Integer year,long userid);
```

2. å®ç°ç±»

```java
 /**
     * è·å–ç­¾åˆ°è®°å½•
     * @param year
     * @param userid
     * @return  ä¸€æ•´å¹´ç­¾åˆ°è®°å½•çš„é›†åˆ  [[2024-09-28:true],[2024-09-29:false],[2024-09-30:false]]
     */
    @Override
    public Map<LocalDate, Boolean> getUserSignIn(Integer year, long userid) {
        //ä¸ä¼ å¹´ä»½ï¼Œé»˜è®¤å½“å¹´

        if (year == null){
            LocalDate now = LocalDate.now();
            year = now.getYear();
        }
        //è·å–signInkey
        String userSignInRedisKey = RedisConstant.getUserSignInRedisKey(year, userid);
        //è·å–bitmapæ•°æ®
        RBitSet signbitSet = redissonClient.getBitSet(userSignInRedisKey);

        // æ„é€ è¿”å›ç»“æœ linkedHashMapä¿è¯æœ‰åº
        LinkedHashMap<LocalDate, Boolean> result = new LinkedHashMap<>();

        //è·å–å½“å‰å¹´æ€»å¤©æ•°
        int totalDays = Year.of(year).length();

        //ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€
        for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {
            // è·å–key ï¼š å½“å‰æ—¥æœŸ
           LocalDate currentDate = LocalDate.ofYearDay(year, dayOfYear);
            // è·å– value ï¼š å½“å‰æ˜¯å¦æœ‰åˆ·é¢˜
            boolean hasRecord = signbitSet.get(dayOfYear);
            result.put(currentDate,hasRecord);
        }

        return result;
    }
```

3. cotroller

```java
    /**
     * è·å–ç”¨æˆ·ç­¾åˆ°è®°å½•
     *
     * @param year    å¹´ä»½ï¼ˆä¸ºç©ºè¡¨ç¤ºå½“å‰å¹´ä»½ï¼‰
     * @param request
     * @return ç­¾åˆ°è®°å½•æ˜ å°„
     */
    @GetMapping("/get/sign_in")
    public BaseResponse<Map<LocalDate, Boolean>> getUserSignInRecord(Integer year, HttpServletRequest request) {
        // å¿…é¡»è¦ç™»å½•æ‰èƒ½è·å–
        User loginUser = userService.getLoginUser(request);
        Map<LocalDate, Boolean> userSignInRecord = userService.getUserSignIn(year,loginUser.getId());
        return ResultUtils.success(userSignInRecord);
    }
```

4.æ¥å£æµ‹è¯•

![image-20240929092934021](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929092934021.png)



### 1. 4æ€§èƒ½ä¼˜åŒ–

1. **åˆ¤æ–­æ¯å¤©æ˜¯å¦ç­¾åˆ°é€»è¾‘ä¼˜åŒ–**

ä¸‹è¿°ä»£ç ï¼Œå¾ªç¯å†…å¦‚éœ€è¦åˆ¤æ–­å½“å¤©æ˜¯å¦åˆ·é¢˜ï¼Œå®é™…ä¸Šæ¯æ¬¡åˆ¤æ–­éƒ½å»Redisäº¤äº’ï¼Œä¸€ä¸ªå¾ªç¯è¦äº¤äº’365æ¬¡redis.

```java
// ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€
for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {
    // è·å– keyï¼šå½“å‰æ—¥æœŸ
    LocalDate currentDate = LocalDate.ofYearDay(year, dayOfYear);
    // è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
    boolean hasRecord = signInBitSet.get(dayOfYear);
    // å°†ç»“æœæ”¾å…¥ map
    result.put(currentDate, hasRecord);
}
```

`signinBitSet`æ˜¯é€šè¿‡Redissonå®¢æˆ·ç«¯ä¸Redisäº¤äº’`RBitSet`å¯¹è±¡ï¼Œè€Œ`RBitSet.get(int bitIndex)`è¿™ä¸ªæ–¹æ³•ä¼šè§¦å‘ä¾æ¬¡Rredisè¯·æ±‚æ¥è·å–å¯¹åº”çš„å€¼ï¼Œå¹¶æ²¡æœ‰å·¦æœ¬åœ°ç¼“å­˜ã€‚

è§£å†³æ–¹æ³•ï¼š æˆ‘ä»¬åœ¨å¾ªç¯å¤–ç¼“å­˜ä¸€ä¸‹BitMapæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨JDKè‡ªå¸¦çš„BitSetæ•°æ®ç»“æœåšæœ¬åœ°ç¼“å­˜ã€‚

```java
// åŠ è½½ BitSet åˆ°å†…å­˜ä¸­ï¼Œé¿å…åç»­è¯»å–æ—¶å‘é€å¤šæ¬¡è¯·æ±‚
BitSet bitSet = signInBitSet.asBitSet();
// è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
boolean hasRecord = bitSet.get(dayOfYear);
```



2. **åˆ·é¢˜è®°å½•è¿”å›ç»“æœä¼˜åŒ–**

æˆ‘ä»¬åœ¨è¿”å›æ•°æ®æ—¶çš„æ•°æ®ç»“æ„ä¸ºï¼š

![image-20240929094702886](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929094702886.png)

ä¼ è¾“çš„æ•°æ®è¾ƒå¤šï¼Œè®¡ç®—æ—¶é—´è€—æ—¶ï¼Œå®½å¸¦å ç”¨å¤šï¼Œæ•ˆç‡ä½ã€‚

å®é™…ä¸Šæ²¡æœ‰å¿…è¦å®Œå…¨ç»„è£…å¥½æ•°æ®ä¼ è¾“ç»™å‰ç«¯ï¼Œä»…ä»…å‘Šè¯‰å‰ç«¯é‚£å¤©æœ‰åˆ·é¢˜å°±è¡Œï¼Œè¿™æ ·å¤§å¤§å‡å°‘ä¼ è¾“çš„æ•°æ®é‡ä»¥åŠåç«¯cpuå ç”¨ï¼Œå°†éƒ¨åˆ†è®¡ç®—å‹åŠ›å‡æ‘Šåˆ°ç”¨æˆ·çš„å®¢æˆ·ç«¯ä¸Šï¼ˆæµè§ˆå™¨ï¼‰

è¿”å›çš„æ•°æ®ï¼š1 2 3 

ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public List<Integer> getUserSignInRecord(long userId, Integer year) {
    if (year == null) {
        LocalDate date = LocalDate.now();
        year = date.getYear();
    }
    String key = RedisConstant.getUserSignInRedisKey(year, userId);
    RBitSet signInBitSet = redissonClient.getBitSet(key);
    // åŠ è½½ BitSet åˆ°å†…å­˜ä¸­ï¼Œé¿å…åç»­è¯»å–æ—¶å‘é€å¤šæ¬¡è¯·æ±‚
    BitSet bitSet = signInBitSet.asBitSet();
    // ç»Ÿè®¡ç­¾åˆ°çš„æ—¥æœŸ
    List<Integer> dayList = new ArrayList<>();
    // è·å–å½“å‰å¹´ä»½çš„æ€»å¤©æ•°
    int totalDays = Year.of(year).length();
    // ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€
    for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {
        // è·å– valueï¼šå½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜
        boolean hasRecord = bitSet.get(dayOfYear);
        if (hasRecord) {
          dayList.add(dayOfYear);
        }
    }
    return dayList;
}

```

æ¥å£æµ‹è¯•

![image-20240929095737893](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929095737893.png)

3. **è®¡ç®—ä¼˜åŒ–**

BitSet æ˜¯ä¸€bitä½å­˜æ•°æ®çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œåªèƒ½å­˜01ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä½è¿ç®—ï¼Œä»£æ›¿ä½¿ç”¨ä¸Šè¿°forå¾ªç¯çš„æ£€æŸ¥é€»è¾‘ï¼Œè·³è¿‡æ— ç”¨çš„æ£€æŸ¥ã€‚

åœ¨Javaä¸­çš„`BitSet`ç±»ä¸­å¯ä»¥ä½¿ç”¨`nextSetBit(int fromIndex)`å’Œ`nextClearBit(int fromIndex)`æ–¹æ³•æ¥è·å–ä»æŒ‡å®šä¸‹æ ‡å¼€å§‹çš„ä¸‹ä¸€ä¸ªï¼ˆ1æˆ–0ï¼‰çš„ä½.

* `nextSetBit(int fromIndex)`:ä»`formindex`èµ·ï¼ˆåŒ…æ‹¬`fromindex`ï¼‰å¯»æ‰¾ä¸‹ä¸€ä¸ªä¸º1çš„ä½ï¼Œå¦‚æœæ‰¾åˆ°è¿”å›è¯¥ä½çš„ä¸‹æ ‡ï¼Œå¦‚æœæœªæ‰¾åˆ°è¿”å› -1.
* `nextClearBit(int fromIndex) `ï¼šä»`formindex`èµ·ï¼ˆåŒ…æ‹¬`fromindex`ï¼‰å¯»æ‰¾ä¸‹ä¸€ä¸ªä¸º0çš„ä½ï¼Œå¦‚æœæ‰¾åˆ°è¿”å›è¯¥ä½çš„ä¸‹æ ‡ï¼Œå¦‚æœæœªæ‰¾åˆ°è¿”å› å¤§çš„æ•´æ•°å€¼

ä¹‹æ‰€ä»¥èƒ½è·³è¿‡æ— ç”¨å¾ªç¯çš„åŸå› åœ¨äºï¼Œä»£ç å¦‚ä¸‹

```java
public int nextSetBit(int fromIndex) {
        if (fromIndex < 0)
            throw new IndexOutOfBoundsException("fromIndex < 0: " + fromIndex);

        checkInvariants();

        int u = wordIndex(fromIndex);
        if (u >= wordsInUse)
            return -1;

        long word = words[u] & (WORD_MASK << fromIndex);

        while (true) {
            if (word != 0)
                return (u * BITS_PER_WORD) + Long.numberOfTrailingZeros(word);
            if (++u == wordsInUse)
                return -1;
            word = words[u];
        }
    }
```

ä¸šåŠ¡ä»£ç ä¿®æ”¹å¦‚ä¸‹

```java
     //ä¾æ¬¡è·å–æ¯ä¸€å¤©çš„ç­¾åˆ°çŠ¶æ€ ä¼˜åŒ–ç‰ˆ
        int i = bitSet.nextSetBit(0);
        while (i >= 0){
            result.add(i);
           i =  bitSet.nextSetBit(i+1);
        }

```

**ä¼˜åŒ–å°ç»“**

1. å‡å°‘ç½‘è·¯è¯·æ±‚æˆ–è°ƒç”¨æ¬¡æ•°
2. å‡å°‘ä¼ è¾“æ•°æ®çš„ä½“ç§¯
3. å‡å°‘å¾ªç¯è®¡ç®—
4. é€šè¿‡å®¢æˆ·ç«¯å‡å°‘æœåŠ¡å™¨å‹åŠ›



## 2. åˆ†è¯çš„é¢˜ç›®æœç´¢

### 2.1éœ€æ±‚åˆ†æ

ç”±äºæˆ‘ä»¬ä½¿ç”¨sqlçš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œåœ¨è¿›è¡Œä¸‹è¿°æ“ä½œä¸­ï¼Œå¹¶ä¸èƒ½æœåˆ°é¢˜ç›®ï¼Œæ¨¡ç³ŠæŸ¥è¯¢ä¸çµæ´»ã€‚

![image-20240929162207007](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929162207007.png)

### 2.2 æ–¹æ¡ˆè®¾è®¡

ä½¿ç”¨Elasticsearchå®ç°é¢˜ç›®æ•°æ®çš„å­˜å‚¨å’Œåˆ†è¯æœç´¢ï¼Œéœ€è¦å°†æ•°æ®åº“çš„æ•°æ®åŒæ­¥åˆ°Elasticsearchä¸­ã€‚

[Documentation (elastic.co)](https://www.elastic.co/docs)







### 2.3å®‰è£…Elasticsearch

1.å®‰è£…ES

ç‰ˆæœ¬é€‰æ‹©7.17

å®‰è£…å‚è€ƒæ–‡æ¡£ï¼š[Set up Elasticsearch | Elasticsearch Guide [7.17\] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html)

windows:[Install Elasticsearch with .zip on Windows | Elasticsearch Guide [7.17\] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/zip-windows.html)

ä¸‹è½½è§£å‹åï¼šè¿›å…¥ESç›®å½•å¹¶æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼š

```shell
.\bin\elasticsearch.bat
```

æ£€éªŒæ˜¯å¦è¿è¡ŒæˆåŠŸå‚è€ƒå®˜æ–¹æ–‡æ¡£

![image-20240929173737332](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929173737332.png)

```shell
curl -X GET "localhost:9200/?pretty"
```

![image-20240929173718509](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929173718509.png)



2. å®‰è£…Kibana  7.17

å‚è€ƒæ–‡æ¡£ï¼š[Kibanaâ€”your window into Elastic | Kibana Guide [7.17\] | Elastic](https://www.elastic.co/guide/en/kibana/7.17/introduction.html)

å®‰è£…ï¼š[Install Kibana | Kibana Guide [7.17\] | Elastic](https://www.elastic.co/guide/en/kibana/7.17/install.html)

å¯åŠ¨

```shell
.\bin\kibana.bat
```

é…ç½®

![image-20240929180640031](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929180640031.png)

æµ‹è¯•ï¼š 5601





åˆ†è¯å™¨æµ‹è¯•ï¼šlocalhost:5601

```json
POST /_analyze
{
  "analyzer": "standard", 
  "text": "æç¡•æ˜¯javaå·¥ç¨‹å¸ˆï¼Œè´Ÿè´£åç«¯æŠ€æœ¯é€‰å‹ä»¥åŠå¼€å‘å·¥ä½œ"
}

```

![image-20240929182524138](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929182524138.png)

ESé»˜è®¤æä¾›çš„åˆ†è¯å™¨

![image-20240929180929892](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929180929892.png)

ä½†æ˜¯è¿™äº›åˆ†è¯å™¨éƒ½ä¸æ”¯æŒä¸­æ–‡ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…ikä¸­æ–‡åˆ†è¯å™¨ã€‚

3. å®‰è£…ikåˆ†è¯å™¨

å‚è€ƒæ–‡æ¡£ï¼š[infinilabs/analysis-ik: ğŸšŒ The IK Analysis plugin integrates Lucene IK analyzer into Elasticsearch and OpenSearch, support customized dictionary. (github.com)](https://github.com/infinilabs/analysis-ik)

ikåˆ†è¯å™¨ç‰ˆæœ¬è¦å’ŒESç‰ˆæœ¬ä¸€è‡´ï¼š[Index of: analysis-ik/stable/ (infinilabs.com)](https://release.infinilabs.com/analysis-ik/stable/)

å®‰è£…ï¼šè¿›å…¥esç›®å½•

```shell
.\bin\elasticsearch-plugin.bat install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-7.17.24.zip
```

![image-20240929183034276](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929183034276.png)

**ikåˆ†è¯å™¨æä¾›äº†ä¸¤ä¸ªåˆ†è¯å™¨ ï¼š `ik_smart`**å’Œ`ik_max_word`ã€‚

* ik_smart æ˜¯åªèƒ½åˆ†è¯ï¼Œå°½é‡é€‰æ‹©æœ€æƒ³ä¸€ä¸ªè¯çš„æ‹†åˆ†æ–¹å¼æ¯”å¦‚â€œå¥½å­¦ç”Ÿè¢«è¯†åˆ«ä¸ºä¸€ä¸ªè¯â€
* ik_max_word å°½å¯èƒ½ çš„åˆ†è¯ï¼ŒåŒ…æ‹¬ç»„åˆè¯æ¯”å¦‚ï¼šâ€œå¥½å­¦ç”Ÿâ€ è¢«è¯†åˆ«ä¸‰ä¸ªè¯ï¼šå¥½å­¦ç”Ÿï¼Œå¥½å­¦ï¼Œå­¦ç”Ÿ

æµ‹è¯•ï¼š

```json
POST /_analyze
{
  "analyzer": "ik_smart", 
  "text": "æç¡•æ˜¯javaå·¥ç¨‹å¸ˆï¼Œè´Ÿè´£åç«¯æŠ€æœ¯é€‰å‹ä»¥åŠå¼€å‘å·¥ä½œ"
}

```

![image-20240929183730251](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929183730251.png)

![image-20240929201623323](images/å¼€å‘æ‰‹å†Œ.assets/image-20240929201623323.png)

ä¸¤ä¸ªåˆ†è¯å™¨çš„é€‰ç”¨ä½¿ç”¨ï¼š

* `ik_smart`:**é€‚ç”¨äºæœç´¢åˆ†è¯**ï¼Œåœ¨æŸ¥è¯¢ä½¿ç”¨ï¼Œä¿è¯æ€§èƒ½çš„åŒæ—¶æä¾›åˆç†çš„åˆ†è¯ç²¾åº¦
* `ik_max_word`ï¼š**é€‚ç”¨äºåº•å±‚ç´¢å¼•åˆ†è¯**ï¼Œç¡®ä¿åœ¨å»ºç«‹ç´¢å¼•æ—¶å°½å¯èƒ½çš„å¤šåˆ†è¯ï¼Œæé«˜æŸ¥è¯¢æ—¶çš„åŒ¹é…åº¦å’Œè¦†ç›–é¢ã€‚

tips:**IKåˆ†è¯å™¨è¯†åˆ«è¯æ±‡ä¸å‡†ç¡®ï¼Œå°±å¦‚ä¸Šè¿°ä¸è®¤è¯†â€œæç¡•â€ï¼Œé‚£ä¹ˆæ€ä¹ˆè®©ikæŒ‰ç…§è‡ªå·±çš„è§„åˆ™åˆ†è¯ï¼Ÿ**

å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰è¯å…¸ï¼š[infinilabs/analysis-ik at v7.17.18 (github.com)](https://github.com/infinilabs/analysis-ik/tree/v7.17.18?tab=readme-ov-file#dictionary-configuration)



### 2.4 åˆ›å»ºESåº“

```json
PUT /question_v1
{
  "aliases": {
    "question": {}
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "tags": {
        "type": "keyword"
      },
      "answer": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "userId": {
        "type": "long"
      },
      "editTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "createTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "updateTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "isDelete": {
        "type": "keyword"
      }
    }
  }
}
```

### 2.5 åˆ›å»ºESå®¢æˆ·ç«¯

1. å¼•å…¥ä¾èµ–

```xml
<!-- elasticsearch-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

2. yamlé…ç½®

```yaml
spring:
  elasticsearch:
    uris: http://xxx:9200
    username: elastic
    password: admin
```



3. ä½¿ç”¨

SpringDateEs Template

æˆ–è€…ç»§æ‰¿



### 2.6å¼€å‘

ESDTO

```java

@Document(indexName = "question")
@Data
public class QuestionEsDTO implements Serializable {
    private static final String DATE_TIME_PATTERN = "yyyy-MM-dd HH:mm:ss";
    /**
     * id
     */
    @Id
    private Long id;
    /**
     * æ ‡é¢˜
     */
    private String title;
    /**
     * å†…å®¹
     */
    private String content;
    /**
     * ç­”æ¡ˆ
     */
    private String answer;
    /**
     * æ ‡ç­¾åˆ—è¡¨
     */
    private List<String> tags;
    /**
     * åˆ›å»ºç”¨æˆ· id
     */
    private Long userId;
    /**
     * åˆ›å»ºæ—¶é—´
     */
    @Field(type = FieldType.Date, format = {}, pattern = DATE_TIME_PATTERN)
    private Date createTime;
    /**
     * æ›´æ–°æ—¶é—´
     */
    @Field(type = FieldType.Date, format = {}, pattern = DATE_TIME_PATTERN)
    private Date updateTime;
    /**
     * æ˜¯å¦åˆ é™¤
     */
    private Integer isDelete;
    private static final long serialVersionUID = 1L;
    /**
     * å¯¹è±¡è½¬åŒ…è£…ç±»
     *
     * @param question
     * @return
     */
    public static QuestionEsDTO objToDto(Question question) {
        if (question == null) {
            return null;
        }
        QuestionEsDTO questionEsDTO = new QuestionEsDTO();
        BeanUtils.copyProperties(question, questionEsDTO);
        String tagsStr = question.getTags();
        if (StrUtil.isNotBlank(tagsStr)) {
            questionEsDTO.setTags(JSONUtil.toList(tagsStr, String.class));
        }
        return questionEsDTO;
    }
    /**
     * åŒ…è£…ç±»è½¬å¯¹è±¡
     *
     * @param questionEsDTO
     * @return
     */
    public static Question dtoToObj(QuestionEsDTO questionEsDTO) {
        if (questionEsDTO == null) {
            return null;
        }
        Question question = new Question();
        BeanUtils.copyProperties(questionEsDTO, question);
        List<String> tagList = questionEsDTO.getTags();
        if (CollUtil.isNotEmpty(tagList)) {
            question.setTags(JSONUtil.toJsonStr(tagList));
        }
        return question;
    }
}
```

DAO

```java
/**
 * é¢˜ç›® ES æ“ä½œ

 */
public interface QuestionEsDao extends ElasticsearchRepository<QuestionEsDTO, Long> {


//    List<QuestionEsDao> findByUserId(Long userId);
}
```

å…¨é‡åŒæ­¥åˆ°ES

```java
import cn.hutool.core.collection.CollUtil;
import com.ls.mianshidog.esdao.QuestionEsDao;
import com.ls.mianshidog.model.dto.question.QuestionEsDTO;
import com.ls.mianshidog.model.entity.Question;
import com.ls.mianshidog.model.entity.User;
import com.ls.mianshidog.service.QuestionService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;
import javax.annotation.Resource;
import java.util.List;
import java.util.stream.Collectors;
/**
 * å…¨é‡åŒæ­¥é¢˜ç›®åˆ° es

 */
// todo å–æ¶ˆæ³¨é‡Šå¼€å¯ä»»åŠ¡
@Component
@Slf4j
public class FullSyncQuestionToEs implements CommandLineRunner {
    @Resource
    private QuestionService questionService;
    @Resource
    private QuestionEsDao questionEsDao;
    @Override
    public void run(String... args) {
        // å…¨é‡è·å–é¢˜ç›®ï¼ˆæ•°æ®é‡ä¸å¤§çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼‰
        List<Question> questionList = questionService.list();
        if (CollUtil.isEmpty(questionList)) {
            return;
        }
        // è½¬ä¸º ES å®ä½“ç±»
        List<QuestionEsDTO> questionEsDTOList = questionList.stream()
                .map(QuestionEsDTO::objToDto)
                .collect(Collectors.toList());
        // åˆ†é¡µæ‰¹é‡æ’å…¥åˆ° ES
        final int pageSize = 500;
        int total = questionEsDTOList.size();
        log.info("FullSyncQuestionToEs start, total {}", total);
        for (int i = 0; i < total; i += pageSize) {
            // æ³¨æ„åŒæ­¥çš„æ•°æ®ä¸‹æ ‡ä¸èƒ½è¶…è¿‡æ€»æ•°æ®é‡
            int end = Math.min(i + pageSize, total);
            log.info("sync from {} to {}", i, end);
            User user = new User();

            questionEsDao.saveAll(questionEsDTOList.subList(i,end));
//            questionEsDao.saveAll(questionEsDTOList.subList(i, end));
        }
        log.info("FullSyncQuestionToEs end, total {}", total);
    }
}


```

æµ‹è¯•  å¼€å§‹æ³¨é‡Šï¼Œå¯åŠ¨é¡¹ç›®ï¼ŒæŸ¥è¯¢ESæ•°æ®

![image-20241001091946759](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001091946759.png)



å¢é‡åŒæ­¥

```java
/**
 * å¢é‡åŒæ­¥å¸–å­åˆ° es

 */
// todo å–æ¶ˆæ³¨é‡Šå¼€å¯ä»»åŠ¡
@Component
@Slf4j
public class IncSyncQuestionToEs {
    @Resource
    private QuestionMapper questionMapper;
    @Resource
    private QuestionEsDao questionEsDao;
    /**
     * æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(fixedRate = 60 * 1000)
    public void run() {
        // æŸ¥è¯¢è¿‘ 5 åˆ†é’Ÿå†…çš„æ•°æ®
        long FIVE_MINUTES = 5 * 60 * 1000L;
        Date fiveMinutesAgoDate = new Date(new Date().getTime() - FIVE_MINUTES);
        List<Question> questionList = questionMapper.listQuestionWithDelete(fiveMinutesAgoDate);
        if (CollUtil.isEmpty(questionList)) {
            log.info("no inc question");
            return;
        }
        List<QuestionEsDTO> questionEsDTOList = questionList.stream()
                .map(QuestionEsDTO::objToDto)
                .collect(Collectors.toList());
        final int pageSize = 500;
        int total = questionEsDTOList.size();
        log.info("IncSyncQuestionToEs start, total {}", total);
        for (int i = 0; i < total; i += pageSize) {
            int end = Math.min(i + pageSize, total);
            log.info("sync from {} to {}", i, end);
            questionEsDao.saveAll(questionEsDTOList.subList(i, end));
        }
        log.info("IncSyncQuestionToEs end, total {}", total);
    }
}
```

å®ç°æ–¹æ³•   `questionMapper.listQuestionWithDelete(fiveMinutesAgoDate);`

```java
public interface QuestionMapper extends BaseMapper<Question> {

    @Select("select * from question where updateTime >= #{minUpdateTime}")
    List<Question> listQuestionWithDelete(Date fiveMinutesAgoDate);
}
```



æµ‹è¯• ä¿®æ”¹æ•°æ®åº“

![image-20241001092117661](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001092117661.png)

ES  æœç´¢

questionService

```java
/**
 * ä» ES æŸ¥è¯¢é¢˜ç›®
 *
 * @param questionQueryRequest
 * @return
 */
Page<Question> searchFromEs(QuestionQueryRequest questionQueryRequest);

```

å®ç°

```java
 /**
     * ä» ES æŸ¥è¯¢é¢˜ç›®
     *
     * @param questionQueryRequest
     * @return
     */
    @Override
    public Page<Question> searchFromEs(QuestionQueryRequest questionQueryRequest) {
        // è·å–å‚æ•°
        Long id = questionQueryRequest.getId();
        Long notId = questionQueryRequest.getNotId();
        String searchText = questionQueryRequest.getSearchText();
        List<String> tags = questionQueryRequest.getTags();
        Long questionBankId = questionQueryRequest.getQuestionBankId();
        Long userId = questionQueryRequest.getUserId();


        // æ³¨æ„ï¼ŒES çš„èµ·å§‹é¡µä¸º 0
        int current = questionQueryRequest.getCurrent() - 1;
        int pageSize = questionQueryRequest.getPageSize();
        String sortField = questionQueryRequest.getSortField();
        String sortOrder = questionQueryRequest.getSortOrder();

        // æ„é€ æŸ¥è¯¢æ¡ä»¶
        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
        // è¿‡æ»¤
        boolQueryBuilder.filter(QueryBuilders.termQuery("isDelete", 0));
        if (id != null) {
            boolQueryBuilder.filter(QueryBuilders.termQuery("id", id));
        }
        if (notId != null) {
            boolQueryBuilder.mustNot(QueryBuilders.termQuery("id", notId));
        }
        if (userId != null) {
            boolQueryBuilder.filter(QueryBuilders.termQuery("userId", userId));
        }
        if (questionBankId != null) {
            boolQueryBuilder.filter(QueryBuilders.termQuery("questionBankId", questionBankId));
        }
        // å¿…é¡»åŒ…å«æ‰€æœ‰æ ‡ç­¾
        if (CollUtil.isNotEmpty(tags)) {
            for (String tag : tags) {
                boolQueryBuilder.filter(QueryBuilders.termQuery("tags", tag));
            }
        }
        // æŒ‰å…³é”®è¯æ£€ç´¢
        if (StringUtils.isNotBlank(searchText)) {
            boolQueryBuilder.should(QueryBuilders.matchQuery("title", searchText));
            boolQueryBuilder.should(QueryBuilders.matchQuery("content", searchText));
            boolQueryBuilder.should(QueryBuilders.matchQuery("answer", searchText));
            boolQueryBuilder.minimumShouldMatch(1);
        }
        // æ’åº
        SortBuilder<?> sortBuilder = SortBuilders.scoreSort();
        if (StringUtils.isNotBlank(sortField)) {
            sortBuilder = SortBuilders.fieldSort(sortField);
            sortBuilder.order(CommonConstant.SORT_ORDER_ASC.equals(sortOrder) ? SortOrder.ASC : SortOrder.DESC);
        }
        // åˆ†é¡µ
        PageRequest pageRequest = PageRequest.of(current, pageSize);
        // æ„é€ æŸ¥è¯¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
                .withQuery(boolQueryBuilder)
                .withPageable(pageRequest)
                .withSorts(sortBuilder)
                .build();
        SearchHits<QuestionEsDTO> searchHits = elasticsearchRestTemplate.search(searchQuery, QuestionEsDTO.class);
        // å¤ç”¨ MySQL çš„åˆ†é¡µå¯¹è±¡ï¼Œå°è£…è¿”å›ç»“æœ
        Page<Question> page = new Page<>();
        page.setTotal(searchHits.getTotalHits());
        List<Question> resourceList = new ArrayList<>();
        if (searchHits.hasSearchHits()) {
            List<SearchHit<QuestionEsDTO>> searchHitList = searchHits.getSearchHits();
            for (SearchHit<QuestionEsDTO> questionEsDTOSearchHit : searchHitList) {
                resourceList.add(QuestionEsDTO.dtoToObj(questionEsDTOSearchHit.getContent()));
            }
        }
        page.setRecords(resourceList);
        return page;
    }
```



ç¼–å†™æ¥å£

```java
@PostMapping("/search/page/vo")
public BaseResponse<Page<QuestionVO>> searchQuestionVOByPage(@RequestBody QuestionQueryRequest questionQueryRequest,
                                                     HttpServletRequest request) {
    long size = questionQueryRequest.getPageSize();
    // é™åˆ¶çˆ¬è™«
    ThrowUtils.throwIf(size > 200, ErrorCode.PARAMS_ERROR);
    Page<Question> questionPage = questionService.searchFromEs(questionQueryRequest);
    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));
}

```

æµ‹è¯•

ä¹‹å‰çš„æœç´¢

![image-20241001095843684](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001095843684.png)

ç°åœ¨çš„æœç´¢

![image-20241001100652154](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001100652154.png)



## 3. æ‰¹é‡ç®¡ç†é¢˜ç›®

### 3.1 éœ€æ±‚åˆ†æ

ä¸ºäº†æé«˜æ•ˆç‡æ‰¹é‡ç®¡ç†é¢˜ç›®ã€‚ç®¡ç†å‘˜

* æ‰¹é‡å‘é¢˜ç›®æ·»åŠ é¢˜ç›®
* æ‰¹é‡å‘é¢˜åº“åˆ é™¤é¢˜ç›®
* æ‰¹é‡åˆ é™¤é¢˜ç›®



### 3.2 æ–¹æ¡ˆè®¾è®¡

å¾ªç¯å‘æ•°æ®åº“æ“ä½œï¼Œç”±äºæ˜¯æ‰¹é‡æ“ä½œæ‰€ä»¥åŠ ä¸Šäº‹åŠ¡ï¼Œæœ‰ä»»ä½•å¤±è´¥éƒ½æŠ›å‡ºå¼‚å¸¸å’Œå›æ»š ã€‚



### 3. 3å¼€å‘æ¥å£

#### 3.3.1 æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®å…³ç³»

ä¸šåŠ¡é€»è¾‘ï¼š å‰ç«¯ä¼ æ¥é¢˜ç›®idé›†åˆï¼Œå’Œé¢˜åº“idå’Œç”¨æˆ·ä¿¡æ¯ï¼Œåç«¯è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œæ ¹æ®idé›†åˆæŸ¥è¯¢æŸ¥è¯¢æ•°æ®åº“è·å–æœ‰æ•ˆçš„idé›†åˆï¼Œå¾ªç¯æ“ä½œï¼Œå‘é¢˜åº“åŠ å…¥ã€‚



DTO

```java
/**
 * æ‰¹é‡å‘é¢˜åº“å¢åŠ é¢˜ç›®
com.ls
 */
@Data
public class QuestionBankQuestionBatchAddRequest implements Serializable {

    /**
     * id
     */
    @TableId(type = IdType.ASSIGN_ID)
    private Long questionBankId;

    /**
     * é¢˜åº“ id
     */
    private List<Long> questionIdList;

    private static final long serialVersionUID = 1L;
}

```

`QuestionBankQuetsitonService` æ¥å£

```java
 /**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡åŠ å…¥åˆ°é¢˜åº“
     * @param questionIdList
     * @param questionBankId
     * @param uer
     */
    void addQuestionToQuestionBankByIdList(List<Long> questionIdList, long questionBankId, User uer);
```



å®ç°

```java

    /**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡åŠ å…¥åˆ°é¢˜åº“
     * @param questionIdList
     * @param questionBankId
     * @param user
     */
    @Override
    public void addQuestionToQuestionBankByIdList(List<Long> questionIdList, long questionBankId, User user) {
        // é€»è¾‘æ ¡éªŒå‚æ•°
        ThrowUtils.throwIf(questionIdList ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(questionBankId <= 0,ErrorCode.NOT_FOUND_ERROR,"é¢˜åº“idä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(user == null,ErrorCode.NOT_FOUND_ERROR,"ç”¨æˆ·ä¸èƒ½ä¸ºç©º");

        // ä¸šåŠ¡æ ¡éªŒå‚æ•°
        //æ ¡éªŒé¢˜ç›®idé›†åˆ
        List<Question> questions = questionService.listByIds(questionIdList);
        List<Long> idList = questions.stream()
                .map(Question::getId)
                .collect(Collectors.toList());
        ThrowUtils.throwIf(idList ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");

        //æ ¡éªŒé¢˜åº“id
        QuestionBank questionBank = questionBankService.getById(questionBankId);
        ThrowUtils.throwIf(questionBank ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜åº“ä¸å­˜åœ¨");


        //æ‰¹é‡æ’å…¥
        for (Long questionId : idList) {
            QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
            questionBankQuestion.setQuestionBankId(questionBankId);
            questionBankQuestion.setQuestionId(questionId);
            questionBankQuestion.setUserId(user.getId());
            boolean result = this.save(questionBankQuestion);
            //å¦‚æœå¤±è´¥
            if (!result) {
               throw  new BusinessException(ErrorCode.OPERATION_ERROR,"å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
            }
        }


    }
```

æ¥å£

```java
 /**
     * æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®
     * @param questionBankQuestionBatchAddRequest
     * @param request
     * @return
     */
    @PostMapping("/add/batch")
    public BaseResponse<Boolean> addQuestionToBankByIdList(@RequestBody QuestionBankQuestionBatchAddRequest questionBankQuestionBatchAddRequest, HttpServletRequest request) {
        ThrowUtils.throwIf(questionBankQuestionBatchAddRequest == null, ErrorCode.PARAMS_ERROR);

        Long questionBankId = questionBankQuestionBatchAddRequest.getQuestionBankId();
        List<Long> questionIdList = questionBankQuestionBatchAddRequest.getQuestionIdList();
        User loginUser = userService.getLoginUser(request);

        //æ ¡éªŒ
        ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);

        questionBankQuestionService.addQuestionToQuestionBankByIdList(questionIdList, questionBankId, loginUser);
        return ResultUtils.success(true);

    }
```

æµ‹è¯•ï¼š





#### 3.3.2 æ‰¹é‡å‘é¢˜åº“ç§»é™¤é¢˜ç›®å…³ç³»

DTO

```java

/**
 * æ‰¹é‡å‘é¢˜åº“ç§»é™¤é¢˜ç›®å…³ç³»
com.ls
 */
@Data
public class QuestionBankQuestionBatchRemoveRequest implements Serializable {

    /**
     * id
     */
    @TableId(type = IdType.ASSIGN_ID)
    private Long questionBankId;

    /**
     * é¢˜åº“ idåˆ—è¡¨
     */
    private List<Long> questionIdList;

    private static final long serialVersionUID = 1L;
}
```

quesitonBankQuetionService æ¥å£

```java
/**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡ç§»é™¤åˆ°é¢˜åº“å…³ç³»
     * @param questionIdList
     * @param questionBankId
     * @param user
     */
    void removeQuestionToQuestionBankByIdList(List<Long> questionIdList, long questionBankId, User user);
```



å®ç°ç±»

```java
 /**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡åŠ å…¥åˆ°é¢˜åº“
     * @param questionIdList
     * @param questionBankId
     * @param user
     */
    @Override
    public void removeQuestionToQuestionBankByIdList(List<Long> questionIdList, long questionBankId, User user) {
        // é€»è¾‘æ ¡éªŒå‚æ•°
        ThrowUtils.throwIf(questionIdList ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(questionBankId <= 0,ErrorCode.NOT_FOUND_ERROR,"é¢˜åº“idä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(user == null,ErrorCode.NOT_FOUND_ERROR,"ç”¨æˆ·ä¸èƒ½ä¸ºç©º");

        // ä¸šåŠ¡æ ¡éªŒå‚æ•°
        //æ ¡éªŒé¢˜ç›®idé›†åˆ
        List<Question> questions = questionService.listByIds(questionIdList);
        List<Long> idList = questions.stream()
                .map(Question::getId)
                .collect(Collectors.toList());

        ThrowUtils.throwIf(idList == null,ErrorCode.NOT_FOUND_ERROR,"é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");

        //æ ¡éªŒé¢˜åº“id
        QuestionBank questionBank = questionBankService.getById(questionBankId);
        ThrowUtils.throwIf(questionBank ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜åº“ä¸å­˜åœ¨");


        //æ‰¹é‡åˆ é™¤
        for (Long questionId : idList) {
            LambdaQueryWrapper<QuestionBankQuestion> queryWrapper = new LambdaQueryWrapper<>();

            queryWrapper.eq(QuestionBankQuestion::getQuestionId,questionId)
                    .eq(QuestionBankQuestion::getQuestionBankId,questionBankId);
            boolean result = this.remove(queryWrapper);

            //å¦‚æœå¤±è´¥
            if (!result) {
                throw  new BusinessException(ErrorCode.OPERATION_ERROR,"å‘é¢˜åº“æ‰¹é‡ç§»é™¤å…³ç³»å¤±è´¥");
            }
        }
    }
```

controller

```java
   /**
     * æ‰¹é‡å‘é¢˜åº“ç§»é™¤é¢˜ç›®
     * @param questionBankQuestionBatchRemoveRequest
     * @param request
     * @return
     */
    @PostMapping("/remove/batch")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> removeQuestionToBankByIdList(@RequestBody QuestionBankQuestionBatchRemoveRequest questionBankQuestionBatchRemoveRequest, HttpServletRequest request) {
        ThrowUtils.throwIf(questionBankQuestionBatchRemoveRequest == null, ErrorCode.PARAMS_ERROR);

        Long questionBankId = questionBankQuestionBatchRemoveRequest.getQuestionBankId();
        List<Long> questionIdList = questionBankQuestionBatchRemoveRequest.getQuestionIdList();
        User loginUser = userService.getLoginUser(request);

        //æ ¡éªŒ
        ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);

        questionBankQuestionService.removeQuestionToQuestionBankByIdList(questionIdList, questionBankId, loginUser);
        return ResultUtils.success(true);
    }
```

#### 3.3.3 æ‰¹é‡åˆ é™¤é¢˜ç›®

å¯¹äºæ‰¹é‡åˆ é™¤é¢˜ç›®åŠŸèƒ½ï¼Œéœ€è¦åœ¨åˆ é™¤é¢˜ç›®æ—¶ï¼Œç§»é™¤é¢˜ç›®å…³ç³»ã€‚

DTO   questionDto

```java
/**
 * æ‰¹é‡åˆ é™¤é¢˜ç›®è¯·æ±‚
 */
@Data
public class QuestionRemoveBatchRequest implements Serializable {

    /**
     * é¢˜ç›®idåˆ—è¡¨
     */
    private List<Long> questionIdList;

    private static final long serialVersionUID = 1L;
}

```

QuestionSevice 

```java
/**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡ç§»é™¤åˆ°é¢˜åº“å…³ç³»
     * @param questionIdList
     * @param questionBankId
     * @param user
     */
    void removeQuestionToQuestionBankByIdList(List<Long> questionIdList, User user);
```

å®ç°

```java
/**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡ç§»é™¤åˆ°é¢˜åº“å…³ç³»
     * @param questionIds
     * @param user
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void removeBatchQuestionAndQuestionBankQuestionByIds(List<Long> questionIds, User user) {
        // é€»è¾‘å‚æ•°æ ¡éªŒ
        ThrowUtils.throwIf(questionIds == null, ErrorCode.NOT_FOUND_ERROR, "é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(user == null, ErrorCode.NOT_LOGIN_ERROR, "ç”¨æˆ·ä¸èƒ½ä¸ºç©º");

        // ä¸šåŠ¡å‚æ•°æ ¡éªŒ
        List<Question> questionList = this.listByIds(questionIds);
        List<Long> questionIdList = questionList.stream()
                .map(Question::getId)
                .collect(Collectors.toList());

       ThrowUtils.throwIf( questionIdList.isEmpty(),ErrorCode.NOT_FOUND_ERROR, "é¢˜ç›®ä¸å­˜åœ¨");

       //æ‰¹é‡åˆ é™¤é¢˜ç›®ä»¥åŠé¢˜åº“å…³ç³»
        for (Long questionId : questionIdList) {
            //ç§»é™¤é¢˜ç›®
            boolean result = this.removeById(questionId);

            if (!result){
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "åˆ é™¤é¢˜ç›®å¤±è´¥");
            }

            //ç§»é™¤é¢˜åº“å…³ç³»
            LambdaQueryWrapper<QuestionBankQuestion> queryWrapper = new LambdaQueryWrapper<>();
            queryWrapper.eq(QuestionBankQuestion::getQuestionId, questionId);
            boolean remove = questionBankQuestionService.remove(queryWrapper);
            if (!remove){
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "åˆ é™¤é¢˜ç›®é¢˜åº“å…³ç³»å¤±è´¥");
            }

        }
    }
```

controller

```java
    /**
     *   æ‰¹é‡åˆ é™¤é¢˜ç›®
     *   åˆ é™¤é¢˜ç›®çš„åŒæ—¶åˆ é™¤é¢˜ç›®é¢˜åº“å…³ç³»
     * @param questionRemoveBatchRequest
     * @param request
     * @return
     */
    @PostMapping("/delete/batch")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> batchDeleteQuestions(@RequestBody QuestionRemoveBatchRequest questionRemoveBatchRequest,
                                                      HttpServletRequest request) {
        ThrowUtils.throwIf(questionRemoveBatchRequest == null, ErrorCode.PARAMS_ERROR);
        User loginUser = userService.getLoginUser(request);
        ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);
        questionService.removeBatchQuestionAndQuestionBankQuestionByIds(questionRemoveBatchRequest.getQuestionIdList(),loginUser);

        return ResultUtils.success(true);
    }

```



æµ‹è¯•ï¼š

**1.æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®å…³ç³»**

ï¼ˆæ­£å¸¸ï¼‰

![image-20241001144025612](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001144025612.png)

![image-20241001144050082](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001144050082.png)

ä½†æ˜¯åœ¨æ·»åŠ é‡å¤çš„å…³ç³»çš„æ—¶å€™æŠ¥é”™ï¼Œæµ‹è¯•4æµ‹è¯•5å·²ç»åŠ å…¥åˆ°Mysqlåº“ä¸­äº†ï¼Œå†æ¬¡æ“ä½œå¤±è´¥

![image-20241001151007575](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001151007575.png)

bug: å·²ç»å­˜åœ¨çš„é¢˜ç›®é¢˜åº“å…³ç³»ï¼Œå†æ¬¡æ’å…¥ä¼šé”™ï¼Œæ‰€ä»¥åœ¨æ’å…¥å…³ç³»ä¹‹å‰å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å…³ç³»

```java
/**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡åŠ å…¥åˆ°é¢˜åº“
     * @param questionIdList
     * @param questionBankId
     * @param user
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void addQuestionToQuestionBankByIdList(List<Long> questionIdList, long questionBankId, User user) {
        // é€»è¾‘æ ¡éªŒå‚æ•°
        ThrowUtils.throwIf(questionIdList ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(questionBankId <= 0,ErrorCode.NOT_FOUND_ERROR,"é¢˜åº“idä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(user == null,ErrorCode.NOT_FOUND_ERROR,"ç”¨æˆ·ä¸èƒ½ä¸ºç©º");

        // ä¸šåŠ¡æ ¡éªŒå‚æ•°
        //æ ¡éªŒé¢˜ç›®idé›†åˆ
        List<Question> questions = questionService.listByIds(questionIdList);
        List<Long> idList = questions.stream()
                .map(Question::getId)
                .collect(Collectors.toList());

        ThrowUtils.throwIf(idList == null,ErrorCode.NOT_FOUND_ERROR,"é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");

        //æ ¡éªŒé¢˜åº“id
        QuestionBank questionBank = questionBankService.getById(questionBankId);
        ThrowUtils.throwIf(questionBank ==null,ErrorCode.NOT_FOUND_ERROR,"é¢˜åº“ä¸å­˜åœ¨");


        //æ‰¹é‡æ’å…¥
        for (Long questionId : idList) {
            QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
            questionBankQuestion.setQuestionBankId(questionBankId);
            questionBankQuestion.setQuestionId(questionId);
            questionBankQuestion.setUserId(user.getId());

            //å…ˆåˆ¤æ–­é¢˜åº“é¢˜ç›®å…³ç³»æ˜¯å¦å·²ç»å­˜åœ¨
            LambdaQueryWrapper<QuestionBankQuestion> queryWrapper = new LambdaQueryWrapper<>();
            queryWrapper.eq(QuestionBankQuestion::getQuestionId,questionId)
                    .eq(QuestionBankQuestion::getQuestionBankId,questionBankId);
            QuestionBankQuestion questionBankQuestionOne = this.getOne(queryWrapper);
            if (questionBankQuestionOne == null) {
                boolean result = this.save(questionBankQuestion);
                //å¦‚æœå¤±è´¥
                if (!result) {
                    throw  new BusinessException(ErrorCode.OPERATION_ERROR,"å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
                }
            }
        }
    }
```



**2.æ‰¹é‡å‘ç§»é™¤é¢˜åº“é¢˜ç›®å…³ç³»**

æ­£å¸¸

![image-20241001144202770](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001144202770.png)

![image-20241001144213379](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001144213379.png)

**3.æ‰¹é‡åˆ é™¤é¢˜ç›®**

![image-20241001144338179](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001144338179.png)

ok

![image-20241001144949650](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001144949650.png)

![image-20241001145003741](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001145003741.png)

é¢˜ç›®åˆ é™¤äº†å…³ç³»ä¹Ÿåˆ é™¤äº†ç¬¦åˆè¦æ±‚ã€‚

ä½†æ˜¯å½“é¢˜ç›®ç°åœ¨ä¸å±äºä»»ä½•é¢˜åº“æ—¶ï¼Œåˆ é™¤é¢˜ç›®å¤±è´¥ï¼ŒåŸå› æ˜¯åˆ é™¤é¢˜ç›®æ—¶ï¼ŒåŒæ—¶åˆ é™¤é¢˜ç›®é¢˜åº“å…³ç³»ï¼Œä½†æ˜¯ä¸å­˜åœ¨å…³ç³»ï¼Œå°±åˆ é™¤å¤±è´¥ã€‚

![image-20241001145450364](images/å¼€å‘æ‰‹å†Œ.assets/image-20241001145450364.png)

ä¿®æ”¹bug ï¼šåˆ é™¤é¢˜ç›®é¢˜åº“å…³ç³»å‰ï¼Œåˆ¤æ–­å…³ç³»æ˜¯å¦å­˜åœ¨

```java
/**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡ç§»é™¤åˆ°é¢˜åº“å…³ç³»
     * @param questionIds
     * @param user
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void removeBatchQuestionAndQuestionBankQuestionByIds(List<Long> questionIds, User user) {
        // é€»è¾‘å‚æ•°æ ¡éªŒ
        ThrowUtils.throwIf(questionIds == null, ErrorCode.NOT_FOUND_ERROR, "é¢˜ç›®idé›†åˆä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(user == null, ErrorCode.NOT_LOGIN_ERROR, "ç”¨æˆ·ä¸èƒ½ä¸ºç©º");

        // ä¸šåŠ¡å‚æ•°æ ¡éªŒ
        List<Question> questionList = this.listByIds(questionIds);
        List<Long> questionIdList = questionList.stream()
                .map(Question::getId)
                .collect(Collectors.toList());

       ThrowUtils.throwIf( questionIdList.isEmpty(),ErrorCode.NOT_FOUND_ERROR, "é¢˜ç›®ä¸å­˜åœ¨");

       //æ‰¹é‡åˆ é™¤é¢˜ç›®ä»¥åŠé¢˜åº“å…³ç³»
        for (Long questionId : questionIdList) {
            //ç§»é™¤é¢˜ç›®
            boolean result = this.removeById(questionId);

            if (!result){
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "åˆ é™¤é¢˜ç›®å¤±è´¥");
            }

            //ç§»é™¤é¢˜åº“å…³ç³»
            //å…ˆçœ‹çœ‹é¢˜ç›®æœ‰æ²¡æœ‰é¢˜ç›®é¢˜åº“å…³ç³»
            LambdaQueryWrapper<QuestionBankQuestion> queryWrapper = new LambdaQueryWrapper<>();
            queryWrapper.eq(QuestionBankQuestion::getQuestionId, questionId);
            QuestionBankQuestion questionBankQuestionOne = questionBankQuestionService.getOne(queryWrapper);

            if (questionBankQuestionOne != null) {
                boolean remove = questionBankQuestionService.remove(queryWrapper);
                if (!remove){
                    throw new BusinessException(ErrorCode.OPERATION_ERROR, "åˆ é™¤é¢˜ç›®é¢˜åº“å…³ç³»å¤±è´¥");
                }
            }
        }
    }
```

æµ‹è¯•  OK

### 3.4 æ‰¹å¤„ç†ä¼˜åŒ–

ä¸Šè¿°ï¼Œä»£ç è¿˜æœ‰ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œæ¯”å¦‚;

* ç¨³å®šæ€§ä½ï¼Œæœ‰ä¸€é“é¢˜ç›®æ“ä½œå¤±è´¥ï¼Œå°±å…¨éƒ¨å‡ºé”™
* æ€§èƒ½è¾ƒä½ï¼ŒåŒæ—¶æ“ä½œçš„é¢˜ç›®è¾ƒå¤šï¼Œæ‰§è¡Œçš„æ—¶é—´ä¼šå¾ˆé•¿

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹è§’åº¦å¯¹æ‰¹å¤„ç†ä»»åŠ¡è¿›è¡Œä¼˜åŒ–

* å¥å£®æ€§
* ç¨³å®šæ€§
* æ€§èƒ½
* æ•°æ®ä¸€è‡´æ€§
* å¯è§‚æµ‹æ€§



**1.å¥å£®æ€§**

å‚æ•°æ ¡éªŒï¼Œæˆ‘ä»¬å·²ç»è¿›è¡Œäº†å‚æ•°é€»è¾‘æ ¡éªŒï¼Œå’Œä¸šåŠ¡æ ¡éªŒï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç¼ºç‚¹ã€‚

æˆ‘ä»¬åœ¨æ‰¹é‡æ’å…¥æ—¶å€™çš„ä¸šåŠ¡å‚æ•°æ ¡éªŒæ˜¯ï¼šåˆ¤æ–­questionIdæ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯æ²¡æœ‰åˆ¤æ–­questtionidæ˜¯å¦å·²ç»åœ¨QuestionBankQuestionä¸­ï¼Œåªæ˜¯åœ¨æ’å…¥çš„æ—¶å€™æ¯æ¬¡éƒ½åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œæ²¡æ¬¡éƒ½è¦ä¸€ä¸ªä¸€ä¸ªæŸ¥æ•°æ®åº“ï¼Œ

å¯ä»¥ä¼˜åŒ–è¿™æ ·ï¼šåœ¨åˆ¤æ–­questionidæ˜¯å¦å­˜åœ¨åè·å–åˆ°å­˜åœ¨çš„idé›†åˆï¼Œç„¶ååœ¨åˆ¤æ–­ä¸åœ¨questionBankQuestionçš„id(å»é™¤å·²ç»å­˜åœ¨åœ¨å…³ç³»è¡¨é‡Œé¢çš„é¢˜ç›®id,åªå–æ’å…¥ä¸åœ¨é¢˜ç›®å…³ç³»è¡¨çš„id)

```java
   //æ ¡éªŒé¢˜ç›®idé›†åˆæ˜¯å¦åœ¨é¢˜åº“ä¸­-->å–å‡ºæ¥ä¸åœ¨é¢˜åº“ä¸­çš„id,é¿å…é‡å¤æ’å…¥
        LambdaQueryWrapper<QuestionBankQuestion> queryWrapper1 = new LambdaQueryWrapper<>();
        queryWrapper1.in(QuestionBankQuestion::getQuestionId, idList)
                .eq(QuestionBankQuestion::getQuestionBankId, questionBankId)
                .select(QuestionBankQuestion::getQuestionId);
        //æŸ¥è¯¢å·²ç»é¢˜åº“ä¸­çš„é¢˜ç›®
        List<Long> existQuestionIdList = this.listObjs(queryWrapper1, obj -> (Long) obj);
        // æœªå­˜åœ¨çš„çš„å…³ç³»ï¼Œæ’å…¥
        List<Long> validQuestionIdList = idList.stream()
                .filter(questionId -> {
                    return !existQuestionIdList.contains(questionId);
                }).collect(Collectors.toList());

        ThrowUtils.throwIf(validQuestionIdList.isEmpty(), ErrorCode.NOT_FOUND_ERROR, "å·²ç»å…¨éƒ¨æ·»åŠ åˆ°é¢˜åº“ä¸­");
        //æ‰¹é‡æ’å…¥
```



**2. ç¨³å®šæ€§**

é¿å…é•¿äº‹åŠ¡ï¼Œå‡å¦‚å¯¼å…¥10wæ‰¹æ•°æ®ä¼šå¯¼è‡´äº‹åŠ¡è¿‡é•¿ï¼Œå½±å“æ•°æ®åº“æ€§èƒ½ï¼ŒæŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œæœ‰ä¸€æ¡æ•°æ®å¤„ç†å¼‚å¸¸å°±ä¼šå›æ»šï¼Œæ€§èƒ½å°±å¾ˆä½ã€‚

æˆ‘ä»¬å¯ä»¥å°†æ•°æ®åˆ†æ‰¹ï¼Œåˆ†æ‰¹å¤„ç†ï¼Œåˆ†æ‰¹å¯¹äº‹åŠ¡ç®¡ç†ã€‚



ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘

```java
//        æ‰¹é‡æ’å…¥
        for (Long questionId : validQuestionIdList) {
            QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
            questionBankQuestion.setQuestionBankId(questionBankId);
            questionBankQuestion.setQuestionId(questionId);
            questionBankQuestion.setUserId(user.getId());
                boolean result = this.save(questionBankQuestion);
                //å¦‚æœå¤±è´¥
                if (!result) {
                    throw  new BusinessException(ErrorCode.OPERATION_ERROR,"å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
                }
            }
        }
```

åˆ†æ‰¹å¤„ç†

```java
        //æ‰¹é‡æ’å…¥---ã€‹åˆ†æ‰¹
        //    å‡å¦‚1000æ•°æ®ä¸ºä¸€æ‰¹
        int batchSize = 1000;
        int totalSize = validQuestionIdList.size();
        for (int i = 0; i < validQuestionIdList.size(); i+=batchSize) {
            int endIndex = Math.min(i + batchSize, totalSize);
            List<Long> subList = validQuestionIdList.subList(i, endIndex);
            //è°ƒç”¨å†…éƒ¨æ–¹æ³•ï¼šäº‹åŠ¡ä¼šå¤±æ•ˆ---ã€‹AOPContexæ‹¿åˆ°ä»£ç†
            QuestionBankQuestionServiceImpl questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();
            questionBankQuestionService.batchAddQuestionToQuestionBankInner(subList, questionBankId, user);
        }
```

å†…éƒ¨æ–¹æ³•

```java
 /**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡åŠ å…¥-->å†…éƒ¨è°ƒç”¨  äº‹åŠ¡
     * @param questionIdList
     * @param questionBankId
     * @param user
     */
    @Transactional(rollbackFor = Exception.class)
   public void batchAddQuestionToQuestionBankInner(List<Long> questionIdList, long questionBankId, User user) {
        //æ‰¹é‡æ’å…¥
        for (Long questionId : questionIdList) {
            QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
            questionBankQuestion.setQuestionBankId(questionBankId);
            questionBankQuestion.setQuestionId(questionId);
            questionBankQuestion.setUserId(user.getId());
            boolean result = this.save(questionBankQuestion);
            //å¦‚æœå¤±è´¥
            if (!result) {
                throw  new BusinessException(ErrorCode.OPERATION_ERROR,"å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
            }
        }
    }
```

æ³¨æ„å¼€å¯ä»£ç†

```java
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
```

**3. æ€§èƒ½ä¼˜åŒ–**

ä¹‹å‰æˆ‘ä»¬æ˜¯ä¸€ä¸ªä¸€ä¸ªsavaåˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ ·å¤šæ¬¡è¿æ¥æ•°æ®åº“æ€§èƒ½ä¸å¥½ï¼Œå¯ä»¥ä»¥ä¸‹savaå¤šä¸ª

å¦‚ä¸‹

```java
/**
     * é€šè¿‡é¢˜ç›®idé›†åˆæ‰¹é‡åŠ å…¥-->å†…éƒ¨è°ƒç”¨  äº‹åŠ¡
     * @param questionIdList
     * @param questionBankId
     * @param user
     */

    @Override
    @Transactional(rollbackFor = Exception.class)
   public void batchAddQuestionToQuestionBankInner(List<Long> questionIdList, long questionBankId, User user) {


        ArrayList<QuestionBankQuestion> questionBankQuestions = new ArrayList<>();
        //æ‰¹é‡æ’å…¥
        for (Long questionId : questionIdList) {
            QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
            questionBankQuestion.setQuestionBankId(questionBankId);
            questionBankQuestion.setQuestionId(questionId);
            questionBankQuestion.setUserId(user.getId());
            questionBankQuestions.add(questionBankQuestion);
        }
        boolean result = this.saveBatch(questionBankQuestions);
        //å¦‚æœå¤±è´¥
        if (!result) {
            throw  new BusinessException(ErrorCode.OPERATION_ERROR,"å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
        }
    }
```

**4.SQlä¼˜åŒ–**

åœ¨è·å–è·å–åˆæ³•é¢˜ç›®idæ—¶å€™ï¼Œå…ˆæ ¹æ®idcé›†åˆæŸ¥è¯¢æ•°æ®åº“ï¼ŒlistByids(ids)è·å–åˆ°æœ‰æ•ˆçš„é¢˜ç›®é›†åˆï¼Œç„¶ååœ¨æ ¹æ®æœ‰æ•ˆçš„é¢˜ç›®é›†åˆè·å–æœ‰æ•ˆçš„é¢˜ç›®idé›†åˆã€‚åœ¨æ‰§è¡ŒlistByIdsçš„æ—¶å€™sqlæ‰§è¡Œå°±select * 

ä½†æ˜¯æˆ‘ä»¬ä»…ä»…è¦id é›†åˆå°±è¡Œã€‚æ‰€ä»¥ä¼˜åŒ–sqlè¯­å¥

```java
  // ä¸šåŠ¡æ ¡éªŒå‚æ•°
        //æ ¡éªŒé¢˜ç›®idé›†åˆ
//        List<Question> questions = questionService.listByIds(questionIdList); --->ä¼˜åŒ–sql
        //åˆæ³•çš„é¢˜ç›®idåˆ—è¡¨
//        List<Long> idList = questions.stream()
//                .map(Question::getId)
//                .collect(Collectors.toList());

        //ä¼˜åŒ–sql
        LambdaQueryWrapper<Question> queryWrapper = Wrappers.lambdaQuery(Question.class)
                .select(Question::getId)
                .in(Question::getId, questionIdList);
        List<Long> idList = questionService.listObjs(queryWrapper,obj -> (Long) obj);
```

**5.å¹¶å‘ç¼–ç¨‹**

ç”±äºæˆ‘ä»¬å·²ç»åˆ†æ‰¹å¤„ç†ï¼Œåœ¨æ“ä½œè¾ƒå¤šï¼Œè¿½æ±‚å¤„ç†æ—¶é—´çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡å¹¶å‘ç¼–ç¨‹è®©å¤šæ‰¹ä»»åŠ¡å…±åŒæ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸€æ‰¹å¤„ç†å®Œåœ¨å¤„ç†ä¸‹ä¸€æ‰¹ã€‚

Java ä¸­å¯ä»¥åˆ©ç”¨å¹¶å‘åŒ…ä¸‹ **CompletableFuture + çº¿ç¨‹æ± ** æ¥å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚

**CompletableFuture** æ˜¯Java8ä¸­å¼•å…¥çš„ä¸€ä¸ªç±»ï¼Œç”¨äºè¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä»–æ˜¯Futureçš„å¢å¼ºç‰ˆï¼Œä¸ä»…ä»…å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥çš„è®¡ç®—ï¼Œè¿˜å¯ä»¥å¯¹å¼‚æ­¥è®¡ç®—çš„ç»“æœè¿›è¡Œç»„åˆï¼Œå¤„ç†ï¼Œå®ç°å¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ã€‚



æ‰¹å¤„ç†ä»»åŠ¡ï¼Œæ˜¯ä¸€æ‰¹ä¸€æ‰¹å¤„ç†ï¼Œä¸Šè¿°ä»£ç æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸€æ‰¹ä¸€æ‰¹å¤„ç†ã€‚

æˆ‘ä»¬å¯ä»¥å¼•å…¥çº¿ç¨‹æ± ï¼Œå¤šä¸ªçº¿ç¨‹ä¸€èµ·å¤„ç†æ‰¹ä»»åŠ¡ã€‚

```java
List<CompletableFuture<Void>> futures = new ArrayList<>();

for (List<Long> subList : splitList(validQuestionIdList, 1000)) {
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        processBatch(subList, questionBankId, loginUser);
    });
    futures.add(future);
}

// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();

```

![image-20241002222516467](images/å¼€å‘æ‰‹å†Œ.assets/image-20241002222516467.png)

```java
// è‡ªå®šä¹‰çº¿ç¨‹æ± 
ThreadPoolExecutor customExecutor = new ThreadPoolExecutor(
        4,                         // æ ¸å¿ƒçº¿ç¨‹æ•°
        10,                        // æœ€å¤§çº¿ç¨‹æ•°
        60L,                       // çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´
        TimeUnit.SECONDS,           // å­˜æ´»æ—¶é—´å•ä½
        new LinkedBlockingQueue<>(1000),  // é˜»å¡é˜Ÿåˆ—å®¹é‡
        new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ä»»åŠ¡
);

```

å¤šçº¿ç¨‹å¤„ç†æ‰¹ä»»åŠ¡

```java
//çº¿ç¨‹æ± 
        ThreadPoolExecutor customExecutor = new ThreadPoolExecutor(
                20,// æ ¸å¿ƒçº¿ç¨‹æ•°
                30,// æœ€å¤§çº¿ç¨‹æ•°
                60,// çº¿ç¨‹ç©ºé—²æ—¶é—´
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(1000),  // é˜»å¡é˜Ÿåˆ—å®¹é‡
                new ThreadPoolExecutor.CallerRunsPolicy()//æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ä»»åŠ¡
        );

        // ä¿å­˜æ‰€æœ‰æ‰¹æ¬¡çš„CompletableFuture
        List<CompletableFuture<Void>> futures = new ArrayList<>();


        //æ‰¹é‡æ’å…¥---ã€‹åˆ†æ‰¹--->>å¤šçº¿ç¨‹å¤„ç†
        //    å‡å¦‚1000æ•°æ®ä¸ºä¸€æ‰¹
        int batchSize = 1000;
        int totalSize = validQuestionIdList.size();
        for (int i = 0; i < validQuestionIdList.size(); i += batchSize) {
            int endIndex = Math.min(i + batchSize, totalSize);
            //åˆ†æ‰¹
            List<Long> subList = validQuestionIdList.subList(i, endIndex);
            //è°ƒç”¨å†…éƒ¨æ–¹æ³•ï¼šäº‹åŠ¡ä¼šå¤±æ•ˆ---ã€‹AOPContexæ‹¿åˆ°ä»£ç†
            QuestionBankQuestionService questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();
            //å¤šçº¿ç¨‹å¤„ç†
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {

                questionBankQuestionService.batchAddQuestionToQuestionBankInner(subList, questionBankId, user);
            },customExecutor);
            futures.add(future);
        }

        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
        //å…³é—­çº¿ç¨‹æ± 
        customExecutor.shutdown();
```

å¹¶å‘ç¼–ç¨‹å¯ä»¥æå‡æ€§èƒ½ï¼Œä½†æ˜¯ä¹Ÿä¼šå ç”¨æ›´å¤šèµ„æºï¼Œå¹¶ä¸”ä¸ªç³»ç»Ÿå¼•å…¥æ›´å¤šçš„ä¸ç¡®å®šæ€§ï¼Œæ¯”å¦‚æŸä¸ªä»»åŠ¡å¼‚å¸¸ï¼Œå…¶ä»–ä»»åŠ¡æ­£å¸¸ï¼Œäº§ç”Ÿä¸ç¡®å®šçš„å½±å“ã€‚å¯¹æ­¤å¯ä»¥ç»™ä»»åŠ¡è¡¥å……å¼‚å¸¸è¡Œä¸ºå¤„ç†ï¼Œé€šè¿‡`exceptionally`æ–¹æ³•å®ç°

```java
CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
    questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
}, customExecutor).exceptionally(ex -> {
    log.error("æ‰¹å¤„ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", ex);
    return null;
});

```

**6.å¼‚æ­¥**

**7.Druidç›‘æ§**

å¦‚ä½•è¿›è¡Œè¿æ¥æ± è°ƒä¼˜ä»¥åŠsqlè°ƒä¼˜å‘¢ï¼Ÿ

å¯è§†åŒ–ç›‘æ§sql

springboot 2.x é»˜è®¤çš„è¿æ¥æ± æ˜¯Hreicpï¼Œæœ€å¿«çš„è¿æ¥æ± ï¼Œä»¥ç®€æ´è½»é‡ä¸ºåã€‚ä½†æ˜¯æ²¡æœ‰ç›‘æ§ï¼Œå¯ä»¥ä½¿ç”¨Druidè¿æ¥æ± æœ‰ç›‘æ§ï¼Œå¯ä»¥ç›‘æ§sql,å¯¹Sqlè°ƒä¼˜ã€‚

1)å¼•å…¥ä¾èµ–[Home Â· alibaba/druid Wiki (github.com)](https://github.com/alibaba/druid/wiki)

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.2.22</version>
</dependency>

<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.2.2</version>
    <exclusions>
        <!-- æ’é™¤é»˜è®¤çš„ HikariCP -->
        <exclusion>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
        </exclusion>
    </exclusions>
</dependency>

```

2ï¼‰é…ç½®

```yaml
spring:
  # æ•°æ®æºé…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/mianshiya
    username: root
    password: 123456
    # æŒ‡å®šæ•°æ®æºç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # Druid é…ç½®
    druid:
      # é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§
      initial-size: 10
      minIdle: 10
      max-active: 10
      # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
      max-wait: 60000
      # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’
      time-between-eviction-runs-millis: 2000
      # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
      min-evictable-idle-time-millis: 600000
      max-evictable-idle-time-millis: 900000
      # ç”¨æ¥æµ‹è¯•è¿æ¥æ˜¯å¦å¯ç”¨çš„SQLè¯­å¥,é»˜è®¤å€¼æ¯ç§æ•°æ®åº“éƒ½ä¸ç›¸åŒ,è¿™æ˜¯mysql
      validationQuery: select 1
      # åº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥ï¼Œå¹¶ä¸”testOnBorrowä¸ºfalseæ—¶ï¼Œè¿æ¥æ± å°†ä¼šåˆ¤æ–­è¿æ¥æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éªŒè¯è¿™æ¡è¿æ¥æ˜¯å¦å¯ç”¨
      testWhileIdle: true
      # å¦‚æœä¸ºtrueï¼Œé»˜è®¤æ˜¯falseï¼Œåº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥æ—¶ï¼Œè¿æ¥æ± ä¼šåˆ¤æ–­è¿™æ¡è¿æ¥æ˜¯å¦æ˜¯å¯ç”¨çš„
      testOnBorrow: false
      # å¦‚æœä¸ºtrueï¼ˆé»˜è®¤falseï¼‰ï¼Œå½“åº”ç”¨ä½¿ç”¨å®Œè¿æ¥ï¼Œè¿æ¥æ± å›æ”¶è¿æ¥çš„æ—¶å€™ä¼šåˆ¤æ–­è¯¥è¿æ¥æ˜¯å¦è¿˜å¯ç”¨
      testOnReturn: false
      # æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheã€‚PSCacheå¯¹æ”¯æŒæ¸¸æ ‡çš„æ•°æ®åº“æ€§èƒ½æå‡å·¨å¤§ï¼Œæ¯”å¦‚è¯´oracle
      poolPreparedStatements: true
      # è¦å¯ç”¨PSCacheï¼Œå¿…é¡»é…ç½®å¤§äº0ï¼Œå½“å¤§äº0æ—¶ï¼Œ poolPreparedStatementsè‡ªåŠ¨è§¦å‘ä¿®æ”¹ä¸ºtrueï¼Œ
      # åœ¨Druidä¸­ï¼Œä¸ä¼šå­˜åœ¨Oracleä¸‹PSCacheå ç”¨å†…å­˜è¿‡å¤šçš„é—®é¢˜ï¼Œ
      # å¯ä»¥æŠŠè¿™ä¸ªæ•°å€¼é…ç½®å¤§ä¸€äº›ï¼Œæ¯”å¦‚è¯´100
      maxOpenPreparedStatements: 20
      # è¿æ¥æ± ä¸­çš„minIdleæ•°é‡ä»¥å†…çš„è¿æ¥ï¼Œç©ºé—²æ—¶é—´è¶…è¿‡minEvictableIdleTimeMillisï¼Œåˆ™ä¼šæ‰§è¡ŒkeepAliveæ“ä½œ
      keepAlive: true
      # Spring ç›‘æ§ï¼Œåˆ©ç”¨aop å¯¹æŒ‡å®šæ¥å£çš„æ‰§è¡Œæ—¶é—´ï¼Œjdbcæ•°è¿›è¡Œè®°å½•
      aop-patterns: "com.springboot.template.dao.*"
      ########### å¯ç”¨å†…ç½®è¿‡æ»¤å™¨ï¼ˆç¬¬ä¸€ä¸ª stat å¿…é¡»ï¼Œå¦åˆ™ç›‘æ§ä¸åˆ°SQLï¼‰##########
      filters: stat,wall,log4j2
      # è‡ªå·±é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filter
      filter:
        # å¼€å¯druiddatasourceçš„çŠ¶æ€ç›‘æ§
        stat:
          enabled: true
          db-type: mysql
          # å¼€å¯æ…¢sqlç›‘æ§ï¼Œè¶…è¿‡2s å°±è®¤ä¸ºæ˜¯æ…¢sqlï¼Œè®°å½•åˆ°æ—¥å¿—ä¸­
          log-slow-sql: true
          slow-sql-millis: 2000
        # æ—¥å¿—ç›‘æ§ï¼Œä½¿ç”¨slf4j è¿›è¡Œæ—¥å¿—è¾“å‡º
        slf4j:
          enabled: true
          statement-log-error-enabled: true
          statement-create-after-log-enabled: false
          statement-close-after-log-enabled: false
          result-set-open-after-log-enabled: false
          result-set-close-after-log-enabled: false
      ########## é…ç½®WebStatFilterï¼Œç”¨äºé‡‡é›†webå…³è”ç›‘æ§çš„æ•°æ® ##########
      web-stat-filter:
        enabled: true                   # å¯åŠ¨ StatFilter
        url-pattern: /* # è¿‡æ»¤æ‰€æœ‰url
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*" # æ’é™¤ä¸€äº›ä¸å¿…è¦çš„url
        session-stat-enable: true       # å¼€å¯sessionç»Ÿè®¡åŠŸèƒ½
        session-stat-max-count: 1000 # sessionçš„æœ€å¤§ä¸ªæ•°,é»˜è®¤100
      ########## é…ç½®StatViewServletï¼ˆç›‘æ§é¡µé¢ï¼‰ï¼Œç”¨äºå±•ç¤ºDruidçš„ç»Ÿè®¡ä¿¡æ¯ ##########
      stat-view-servlet:
        enabled: true                   # å¯ç”¨StatViewServlet
        url-pattern: /druid/* # è®¿é—®å†…ç½®ç›‘æ§é¡µé¢çš„è·¯å¾„ï¼Œå†…ç½®ç›‘æ§é¡µé¢çš„é¦–é¡µæ˜¯/druid/index.html
        reset-enable: false              # ä¸å…è®¸æ¸…ç©ºç»Ÿè®¡æ•°æ®,é‡æ–°è®¡ç®—
        login-username: root # é…ç½®ç›‘æ§é¡µé¢è®¿é—®å¯†ç 
        login-password: 123
        allow: 127.0.0.1 # å…è®¸è®¿é—®çš„åœ°å€ï¼Œå¦‚æœallowæ²¡æœ‰é…ç½®æˆ–è€…ä¸ºç©ºï¼Œåˆ™å…è®¸æ‰€æœ‰è®¿é—®
        deny: # æ‹’ç»è®¿é—®çš„åœ°å€ï¼Œdenyä¼˜å…ˆäºallowï¼Œå¦‚æœåœ¨denyåˆ—è¡¨ä¸­ï¼Œå°±ç®—åœ¨allowåˆ—è¡¨ä¸­ï¼Œä¹Ÿä¼šè¢«æ‹’ç»

```

å¯åŠ¨é¡¹ç›®ï¼šhttp://localhost:8101/api/druid/index.html

![image-20241003001349226](images/å¼€å‘æ‰‹å†Œ.assets/image-20241003001349226.png)

æµ‹è¯•ï¼š å°†è¿æ¥æ± æ”¹å°ç‚¹

![image-20241003001558929](images/å¼€å‘æ‰‹å†Œ.assets/image-20241003001558929.png)

è¿›è¡Œæ‰¹é‡æ“ä½œï¼š

![image-20241003011809746](images/å¼€å‘æ‰‹å†Œ.assets/image-20241003011809746.png)



## 4. ä½¿ç”¨hotKeyç›‘æ§çƒ­ç‚¹æ•°æ®

### 4.1éœ€æ±‚åˆ†æ

ç”¨æˆ·é‡å¤§äº†ä»¥åï¼Œè¿˜æ˜¯ç›´æ¥æŸ¥DB,å¯¹æ•°æ®åº“çš„å‹åŠ›è¾ƒå¤§ã€‚é‚£ä¹ˆä½¿ç”¨Redis+Caffineç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œå¹¶æå‡æ€§èƒ½ã€‚

### 4. 2æ–¹æ¡ˆè®¾è®¡

é‚£ä¹ˆæ€ä¹ˆè®¾ç½®ç¼“å­˜ï¼Ÿæˆ‘ä»¬å¯ä»¥äººå·¥é¢„æƒ³åˆ°é‚£äº›çƒ­ç‚¹æ•°æ®ï¼Œå¯ä»¥å¯¹è¿™æ ·æ•°æ®åšç¼“å­˜é¢„çƒ­ã€‚é‚£äººå·¥é¢„æƒ³ä¸åˆ°çš„æ•°æ®å‘¢ï¼Ÿ

å¯ä»¥å¯¹è¯·æ±‚åˆ¤æ–­åšè®°å½•ï¼Œè®°å½•ä¸€æ®µæ—¶é—´è¯·æ±‚çš„æ¬¡æ•°ï¼Œæ ¹æ®æ¬¡æ•°åˆ¤æ–­æ˜¯å¦çƒ­ç‚¹æ•°æ®ï¼Œæ¯”å¦‚ä½¿ç”¨redisçš„incrå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ¥è®°å½•ä¸€æ®µæ—¶é—´å¯¹æŸä¸ªæ•°æ®çš„è¯·æ±‚æ•°ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯çƒ­keyã€‚

æœ¬æ¬¡æˆ‘ä»¬ä½¿ç”¨jdçš„hotkeyã€‚

### 4.3 hotkeyä»‹ç»

hotkey æ˜¯jdå¼€æºçš„è½»é‡çº§ç»„ä»¶ï¼Œç”¨äºè‡ªåŠ¨ç›‘æµ‹æ•°æ®ï¼Œæ•æ‰çƒ­ç‚¹æ•°æ®ï¼ˆå¯ä»¥ç¼“å­˜ï¼Œåˆ¤æ–­çˆ¬è™«ï¼Œåˆ·å­ç”¨æˆ·ï¼‰ï¼Œå¹¶æä¾›äº†åŸºäºCaffineå®ç°å¯¹çƒ­keyè¿›è¡Œæœ¬åœ°ç¼“å­˜ï¼Œå¹¶æ¯«ç§’çº§æ¨é€åˆ°å„ä¸ªæœåŠ¡ç«¯å†…å­˜ä¸­ã€‚

[hotkey: äº¬ä¸œAppåå°ä¸­é—´ä»¶ï¼Œæ¯«ç§’çº§æ¢æµ‹çƒ­ç‚¹æ•°æ®ï¼Œæ¯«ç§’çº§æ¨é€è‡³æœåŠ¡å™¨é›†ç¾¤å†…å­˜ï¼Œå¤§å¹…é™ä½çƒ­keyå¯¹æ•°æ®å±‚æŸ¥è¯¢å‹åŠ› (gitee.com)](https://gitee.com/jd-platform-opensource/hotkey)

[äº¬ä¸œæ¯«ç§’çº§çƒ­keyæ¢æµ‹æ¡†æ¶è®¾è®¡ä¸å®è·µï¼Œå·²å®æˆ˜äº618å¤§ä¿ƒ (qq.com)](https://mp.weixin.qq.com/s/xOzEj5HtCeh_ezHDPHw6Jw)

æ ¸å¿ƒæµç¨‹

![image-20241007144303910](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007144303910.png)



æ ¸å¿ƒç»„ä»¶ä»‹ç»

**1ã€etcdé›†ç¾¤**

etcdä½œä¸ºä¸€ä¸ªé«˜æ€§èƒ½çš„é…ç½®ä¸­å¿ƒï¼Œå¯ä»¥ä»¥æå°çš„èµ„æºå ç”¨ï¼Œæä¾›é«˜æ•ˆçš„ç›‘å¬è®¢é˜…æœåŠ¡ã€‚ä¸»è¦ç”¨äºå­˜æ”¾è§„åˆ™é…ç½®ï¼Œå„workerçš„ipåœ°å€ï¼Œä»¥åŠæ¢æµ‹å‡ºçš„çƒ­keyã€æ‰‹å·¥æ·»åŠ çš„çƒ­keyç­‰ã€‚

**2ã€clientç«¯jaråŒ…**

å°±æ˜¯åœ¨æœåŠ¡ä¸­æ·»åŠ çš„å¼•ç”¨jarï¼Œå¼•å…¥åï¼Œå°±å¯ä»¥ä»¥ä¾¿æ·çš„æ–¹å¼å»åˆ¤æ–­æŸkeyæ˜¯å¦çƒ­keyã€‚åŒæ—¶ï¼Œè¯¥jarå®Œæˆäº†keyä¸ŠæŠ¥ã€ç›‘å¬etcdé‡Œçš„ruleå˜åŒ–ã€workerä¿¡æ¯å˜åŒ–ã€çƒ­keyå˜åŒ–ï¼Œå¯¹çƒ­keyè¿›è¡Œæœ¬åœ°caffeineç¼“å­˜ç­‰ã€‚

**3ã€workerç«¯é›†ç¾¤**

workerç«¯æ˜¯ä¸€ä¸ªç‹¬ç«‹éƒ¨ç½²çš„Javaç¨‹åºï¼Œå¯åŠ¨åä¼šè¿æ¥etcdï¼Œå¹¶å®šæœŸä¸ŠæŠ¥è‡ªå·±çš„ipä¿¡æ¯ï¼Œä¾›clientç«¯è·å–åœ°å€å¹¶è¿›è¡Œé•¿è¿æ¥ã€‚ä¹‹åï¼Œä¸»è¦å°±æ˜¯å¯¹å„ä¸ªclientå‘æ¥çš„å¾…æµ‹keyè¿›è¡Œç´¯åŠ è®¡ç®—ï¼Œå½“è¾¾åˆ°etcdé‡Œè®¾å®šçš„ruleé˜ˆå€¼åï¼Œå°†çƒ­keyæ¨é€åˆ°å„ä¸ªclientã€‚

**4ã€dashboardæ§åˆ¶å°**

æ§åˆ¶å°æ˜¯ä¸€ä¸ªå¸¦å¯è§†åŒ–ç•Œé¢çš„Javaç¨‹åºï¼Œä¹Ÿæ˜¯è¿æ¥åˆ°etcdï¼Œä¹‹ååœ¨æ§åˆ¶å°è®¾ç½®å„ä¸ªAPPçš„keyè§„åˆ™ï¼Œè­¬å¦‚2ç§’å‡ºç°20æ¬¡ç®—çƒ­keyã€‚ç„¶åå½“workeræ¢æµ‹å‡ºæ¥çƒ­keyåï¼Œä¼šå°†keyå‘å¾€etcdï¼Œdashboardä¹Ÿä¼šç›‘å¬çƒ­keyä¿¡æ¯ï¼Œè¿›è¡Œå…¥åº“ä¿å­˜è®°å½•ã€‚åŒæ—¶ï¼Œdashboardä¹Ÿå¯ä»¥æ‰‹å·¥æ·»åŠ ã€åˆ é™¤çƒ­keyï¼Œä¾›å„ä¸ªclientç«¯ç›‘å¬ã€‚

### 4.4 hotkeyå®æˆ˜

å®˜æ–¹ [hotkey: äº¬ä¸œAppåå°ä¸­é—´ä»¶ï¼Œæ¯«ç§’çº§æ¢æµ‹çƒ­ç‚¹æ•°æ®ï¼Œæ¯«ç§’çº§æ¨é€è‡³æœåŠ¡å™¨é›†ç¾¤å†…å­˜ï¼Œå¤§å¹…é™ä½çƒ­keyå¯¹æ•°æ®å±‚æŸ¥è¯¢å‹åŠ› (gitee.com)](https://gitee.com/jd-platform-opensource/hotkey#å®‰è£…æ•™ç¨‹)

1.å®‰è£…etcd

[Release v3.5.16 Â· etcd-io/etcd (github.com)](https://github.com/etcd-io/etcd/releases/tag/v3.5.16)

![image-20241007145233999](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007145233999.png)

ä¸‹è½½è§£å‹å

![image-20241007145805640](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007145805640.png)

* etcd ï¼š æœåŠ¡æœ¬èº«
* etcdctl ï¼šå®¢æˆ·ç«¯ç”¨æˆ·æ“ä½œetcd
* etcdutl ï¼šå¤‡ä»½å›å¤å·¥å…·

å¯åŠ¨etcdæœåŠ¡åï¼Œå ç”¨2379å’Œ2380ç«¯å£ï¼Œ2379ï¼šæä¾›HTTP API æœåŠ¡ï¼Œå’Œetcdctläº¤äº’ï¼Œ2380é›†ç¾¤èŠ‚ç‚¹é€šä¿¡ã€‚



2.å®‰è£…hotkey

[ä¸‹è½½ä»“åº“ Â· äº¬ä¸œé›¶å”®/hotkey - Gitee.com](https://gitee.com/jd-platform-opensource/hotkey/repository/archive/master-v0.0.4.zip)

ä¸‹è½½è§£å‹ï¼Œæ‰“å¼€é¡¹ç›®ï¼Œä½¿ç”¨jdk 17 ä»¥ä¸‹ã€‚

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç«¯å£ï¼Œetcdåœ°å€

![image-20241007151840563](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007151840563.png)

3.å¯åŠ¨woker

![image-20241007160252614](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007160252614.png)

wokerç›´æ¥æ‰“åŒ…ä¼šå¤±è´¥ï¼Œå› ä¸ºä¾èµ–commonï¼Œæ‰€ä»¥ç›´æ¥å…¨éƒ¨æ‰“åŒ…

![image-20241007160550720](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007160550720.png)

![image-20241007161543017](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007161543017.png)

```java
java -jar worker-0.0.4-SNAPSHOT.jar --etcd.server=127.0.0.1:2379
```



4. å¯åŠ¨dashboard

åˆ›å»ºæ•°æ®åº“

![image-20241007162033603](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007162033603.png)

ä¿®æ”¹æœåŠ¡ç«¯å£å·å’Œetctåœ°å€ å¯åŠ¨é¡¹ç›®

![image-20241007162522467](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007162522467.png)

å¯åŠ¨é¡¹ç›® ï¼šlocalhost:8121

http://127.0.0.1:8121

ä¸çŸ¥é“ä¸ºå•¥ï¼Œå‰è€…ä¸æ˜¾ç¤ºç”¨æˆ·ç®¡ç†



![image-20241007162625096](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007162625096.png)

æ–°å»ºç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·è´Ÿè´£ä¸€ä¸ªapp

![image-20241007165127243](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007165127243.png)

è®¾ç½®è§„åˆ™ å®˜æ–¹ä¾‹å­

![image-20241007165735671](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007165735671.png)å¦‚å›¾å°±æ˜¯ä¸€ç»„è§„åˆ™ï¼Œè­¬å¦‚å…¶ä¸­as__å¼€å¤´çš„çƒ­keyçš„è§„åˆ™å°±æ˜¯interval-2ç§’å†…å‡ºç°äº†threshold-10æ¬¡å°±è®¤ä¸ºå®ƒæ˜¯çƒ­keyï¼Œå®ƒå°±ä¼šè¢«æ¨é€åˆ°jvmå†…å­˜ä¸­ï¼Œå¹¶ç¼“å­˜60ç§’ï¼Œprefix-trueä»£è¡¨å‰ç¼€åŒ¹é…ã€‚é‚£ä¹ˆåœ¨åº”ç”¨ä¸­ï¼Œå°±å¯ä»¥æŠŠä¸€ç»„keyï¼Œéƒ½ç”¨as__å¼€å¤´ï¼Œç”¨æ¥æ¢æµ‹ã€‚

```json
[
{
"duration" : 60,
"interval":2,
"threshold": 10,
"key" :"*",
"prefix":false,
"desc":"çƒ­pin"
}
]
```

5.clientç«¯æ¥å…¥ä½¿ç”¨

å¼•å…¥clientçš„pomä¾èµ–ã€‚

æœ‰ä¸¤ç§æ–¹å¼  1. mavenä»“åº“[Maven Repository: io.github.ck-jesse Â» jd-hotkey-client (mvnrepository.com)](https://mvnrepository.com/artifact/io.github.ck-jesse/jd-hotkey-client)ï¼ˆä¸å»ºè®®ï¼Œå¼•ç”¨å¤ªå°‘ï¼Œè¿˜å‡ºé”™ï¼‰

2. æ‰‹åŠ¨æ‰“åŒ…å¼•å…¥

![image-20241007173636123](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007173636123.png)

æ¥ç€ï¼Œåœ¨éœ€è¦ä½¿ç”¨è¯¥ç»„ä»¶çš„é¡¹ç›®å¼•å…¥ï¼ˆæ”¹ä¸€ä¸‹åå­—ï¼‰

![image-20241007173910503](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007173910503.png)

![image-20241007173959806](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007173959806.png)

libç›®å½•é»˜è®¤å¿½ç•¥åˆ°git,æ‰‹åŠ¨æ·»åŠ ä»¥ä¸‹åˆ°gitã€‚

é€šè¿‡mavenå¼•å…¥å³å¯ï¼š

```xml
<dependency>
  <artifactId>hotkey-client</artifactId>
  <groupId>com.jd.platform.hotkey</groupId>
  <version>0.0.4-SNAPSHOT</version>
  <scope>system</scope>
  <systemPath>${project.basedir}/lib/hotkey-client-0.0.4-SNAPSHOT.jar</systemPath>
</dependency>
```

å¯åŠ¨é¡¹ç›®ï¼Œå‘ç°æŠ¥é”™

![image-20241007174824218](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007174824218.png)

åŸå› æ˜¯ï¼Œåˆšåˆšå¼•å…¥çš„hotkeyï¼ŒjaråŒ…ï¼Œä½œç”¨åŸŸæ˜¯ç³»ç»Ÿï¼Œä¼šç›´æ¥ä½¿ç”¨æœ¬åœ°çš„ï¼Œè·³è¿‡mavenç‰ˆæœ¬æ§åˆ¶ï¼Œè€Œä¸”ä¼˜å…ˆçº§æœ€é«˜ã€‚

![image-20241007175003134](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007175003134.png)

ä¿®æ”¹å†²çªçš„hutool æ–¹æ³•

é…ç½®hotkey

```yaml
# hotkey
hotkey:
  etcd-server: "http://localhost:2379"
  app-name: "mianshidog"
  caffeine-size: 1000
  push-period: 1000
```

åˆå§‹åŒ–hotkey

```java
@Configuration
@ConfigurationProperties(prefix = "hotkey")
@Data
public class HotKeyConfig {

    /**
     * Etcd æœåŠ¡å™¨å®Œæ•´åœ°å€
     */
    private String etcdServer = "http://127.0.0.1:2379";

    /**
     * åº”ç”¨åç§°
     */
    private String appName = "app";

    /**
     * æœ¬åœ°ç¼“å­˜æœ€å¤§æ•°é‡
     */
    private int caffeineSize = 10000;

    /**
     * æ‰¹é‡æ¨é€ key çš„é—´éš”æ—¶é—´
     */
    private long pushPeriod = 1000L;

    /**
     * åˆå§‹åŒ– hotkey
     */
    @Bean
    public void initHotkey() {
        ClientStarter.Builder builder = new ClientStarter.Builder();
        ClientStarter starter = builder.setAppName(appName)
                .setCaffeineSize(caffeineSize)
                .setPushPeriod(pushPeriod)
                .setEtcdServer(etcdServer)
                .build();
        starter.startPipeline();
    }
}
```

![image-20241007181039759](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007181039759.png)



æ³¨æ„ï¼š

å¦‚æœåŸæœ‰é¡¹ç›®é‡Œä½¿ç”¨äº†guavaï¼Œéœ€è¦å‡çº§guavaä¸ºä»¥ä¸‹ç‰ˆæœ¬ï¼Œå¦åˆ™è¿‡ä½çš„guavaç‰ˆæœ¬å¯èƒ½å‘ç”ŸjaråŒ…å†²çªã€‚æˆ–è€…åˆ é™¤è‡ªå·±é¡¹ç›®é‡Œçš„guavaçš„mavenä¾èµ–ï¼Œguavaå‡çº§ä¸ä¼šå½±å“åŸæœ‰ä»»ä½•é€»è¾‘ã€‚

```java
<dependency>
 <groupId>com.google.guava</groupId>
 <artifactId>guava</artifactId>
 <version>28.2-jre</version>
 <scope>compile</scope>
</dependency>
```

æœ‰æ—¶å¯èƒ½é¡¹ç›®é‡Œæ²¡æœ‰ç›´æ¥ä¾èµ–guavaï¼Œä½†æ˜¯å¼•å…¥çš„æŸä¸ªpomé‡Œå¼•äº†guavaï¼Œä¹Ÿéœ€è¦å°†guavaæ’é™¤æ‰ã€‚

å¦‚æœåŸæœ‰é¡¹ç›®ä½¿ç”¨äº†fastjsonï¼Œéœ€è¦é™ä¸º`2.0.0`ç‰ˆæœ¬ä»¥ä¸‹ï¼Œ åœ¨`2.0.0`ç‰ˆæœ¬ä»¥ä¸Šï¼Œ`com.alibaba.fastjson.serializer.JSONLibDataFormatSerializer`ç±»å·²ç»åˆ é™¤ã€‚ å¯¼è‡´JSONå·¥å…·ç±»`com.jd.platform.hotkey.common.tool.FastJsonUtils`åˆå§‹åŒ–æ—¶æ‰¾ä¸åˆ°ç±»ã€‚ è§„åˆ™é…ç½®çš„jsonè½¬æ¢æœ‰é—®é¢˜ã€‚ æ¨èä½¿ç”¨ä¸HotKeyç›¸åŒçš„ç‰ˆæœ¬ï¼š

```java
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.70</version>
</dependency>
```

ä½¿ç”¨ï¼š

ä¸»è¦æœ‰å¦‚ä¸‹4ä¸ªæ–¹æ³•å¯ä¾›ä½¿ç”¨

```java
boolean JdHotKeyStore.isHotKey(String key)
Object JdHotKeyStore.get(String key)
void JdHotKeyStore.smartSet(String key, Object value)
Object JdHotKeyStore.getValue(String key)
```



1 boolean isHotKey(String key) 

è¯¥æ–¹æ³•ä¼šè¿”å›è¯¥keyæ˜¯å¦æ˜¯çƒ­keyï¼Œå¦‚æœæ˜¯è¿”å›trueï¼Œå¦‚æœä¸æ˜¯è¿”å›falseï¼Œå¹¶ä¸”ä¼šå°†keyä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡è®¡ç®—ã€‚è¯¥æ–¹æ³•é€šå¸¸ç”¨äºåˆ¤æ–­åªéœ€è¦åˆ¤æ–­keyæ˜¯å¦çƒ­ã€ä¸éœ€è¦ç¼“å­˜valueçš„åœºæ™¯ï¼Œå¦‚åˆ·å­ç”¨æˆ·ã€æ¥å£è®¿é—®é¢‘ç‡ç­‰ã€‚

2 Object get(String key)

è¯¥æ–¹æ³•è¿”å›è¯¥keyæœ¬åœ°ç¼“å­˜çš„valueå€¼ï¼Œå¯ç”¨äºåˆ¤æ–­æ˜¯çƒ­keyåï¼Œå†å»è·å–æœ¬åœ°ç¼“å­˜çš„valueå€¼ï¼Œé€šå¸¸ç”¨äºredisçƒ­keyç¼“å­˜

3 void smartSet(String key, Object value)

æ–¹æ³•ç»™çƒ­keyèµ‹å€¼valueï¼Œå¦‚æœæ˜¯çƒ­keyï¼Œè¯¥æ–¹æ³•æ‰ä¼šèµ‹å€¼ï¼Œéçƒ­keyï¼Œä»€ä¹ˆä¹Ÿä¸åš

4 Object getValue(String key)

è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæ•´åˆæ–¹æ³•ï¼Œç›¸å½“äºisHotKeyå’Œgetä¸¤ä¸ªæ–¹æ³•çš„æ•´åˆï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›æœ¬åœ°ç¼“å­˜çš„valueã€‚ å¦‚æœæ˜¯çƒ­keyï¼Œåˆ™å­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œ1æ˜¯è¿”å›valueï¼Œ2æ˜¯è¿”å›nullã€‚è¿”å›nullæ˜¯å› ä¸ºå°šæœªç»™å®ƒsetçœŸæ­£çš„valueï¼Œè¿”å›énullè¯´æ˜å·²ç»è°ƒç”¨è¿‡setæ–¹æ³•äº†ï¼Œæœ¬åœ°ç¼“å­˜valueæœ‰å€¼äº†ã€‚ å¦‚æœä¸æ˜¯çƒ­keyï¼Œåˆ™è¿”å›nullï¼Œå¹¶ä¸”å°†keyä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡æ¢æµ‹ã€‚



å®æˆ˜ï¼šç»™é¢˜åº“æ·»åŠ hotkeyç›‘æ§

é…ç½®è§„åˆ™

```json
[
    {
        "duration": 600,
        "key": "bank_detail_",
        "prefix": true,
        "interval": 5,
        "threshold": 10,
        "desc": "çƒ­é—¨é¢˜åº“ç¼“å­˜"
    }
]
```

ä¿®æ”¹æ¥å£

```java
@GetMapping("/get/vo")
public BaseResponse<QuestionBankVO> getQuestionBankVOById(QuestionBankQueryRequest questionBankQueryRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(questionBankQueryRequest == null, ErrorCode.PARAMS_ERROR);
    Long id = questionBankQueryRequest.getId();
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);

    // ç”Ÿæˆ key
    String key = "bank_detail_" + id;
    // å¦‚æœæ˜¯çƒ­ key
    if (JdHotKeyStore.isHotKey(key)) {
        // ä»æœ¬åœ°ç¼“å­˜ä¸­è·å–ç¼“å­˜å€¼
        Object cachedQuestionBankVO = JdHotKeyStore.get(key);
        if (cachedQuestionBankVO != null) {
            // å¦‚æœç¼“å­˜ä¸­æœ‰å€¼ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„å€¼
            return ResultUtils.success((QuestionBankVO) cachedQuestionBankVO);
        }
    }

    // åŸæœ¬æŸ¥è¯¢æ•°æ®çš„é€»è¾‘ï¼ˆæŸ¥æ•°æ®åº“ï¼‰

    // è®¾ç½®æœ¬åœ°ç¼“å­˜
    JdHotKeyStore.smartSet(key, questionBankVO);
    
    // è·å–å°è£…ç±»
    return ResultUtils.success(questionBankVO);
}
```

æµ‹è¯•

![image-20241007225934866](images/å¼€å‘æ‰‹å†Œ.assets/image-20241007225934866.png)

ok

æŒ‰ç…§ä¸Šè¿°â€ï¼šå®ç°è‡ªåŠ¨ç¼“å­˜é¢˜ç›®

è®¾å®šè§„åˆ™

```json
{
        "duration": 600,
        "key": "question_detail_",
        "prefix": true,
        "interval": 5,
        "threshold": 10,
        "desc": "çƒ­é—¨é¢˜ç›®ç¼“å­˜"
    }
```

ä¿®æ”¹æ¥å£

